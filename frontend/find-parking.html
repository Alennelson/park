<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Find Parking Near You - ASP | Book Parking Spaces Online</title>
  <meta name="description" content="Find and book available parking spaces near your location with ASP (A Space for Park). Real-time parking availability, secure booking, and instant confirmation.">
  <meta name="keywords" content="ASP parking, find parking, parking near me, book parking online, available parking, parking map, parking spaces, a space for park">
  <meta name="robots" content="index, follow">
  <link rel="canonical" href="https://www.alen.club/find-parking.html">
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://www.alen.club/find-parking.html">
  <meta property="og:title" content="Find Parking Near You - ASP">
  <meta property="og:description" content="Find and book available parking spaces near your location. Real-time parking availability.">
  <meta property="og:image" content="https://www.alen.club/og-image.jpg">
  
  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:url" content="https://www.alen.club/find-parking.html">
  <meta property="twitter:title" content="Find Parking Near You - ASP">
  <meta property="twitter:description" content="Find and book available parking spaces near your location.">
  <meta property="twitter:image" content="https://www.alen.club/og-image.jpg">
  
  <script src="config.js"></script>

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #FFD400;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }

    .phone {
      width: 360px;
      height: 700px;
      border-radius: 30px;
      overflow: hidden;
      box-shadow: 0 20px 50px rgba(0,0,0,0.4);
      position: relative;
      background: white;
    }

    #map { width: 100%; height: 100%; }

    /* Location Picker Overlay */
    .location-picker {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      background: white;
      padding: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      z-index: 1000;
    }

    .location-picker h3 {
      margin: 0 0 10px 0;
      font-size: 16px;
    }

    .location-picker p {
      margin: 5px 0;
      font-size: 12px;
      color: #666;
    }

    .search-btn {
      width: 100%;
      padding: 12px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 10px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 10px;
    }

    .use-current-location {
      width: 100%;
      padding: 10px;
      background: #2196F3;
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      cursor: pointer;
      margin-top: 5px;
    }

    .panel {
      position: absolute;
      bottom: 0;
      width: 100%;
      background: #fff;
      padding: 15px;
      text-align: center;
      display: none;
      box-shadow: 0 -5px 15px rgba(0,0,0,0.2);
      max-height: 300px;
      overflow-y: auto;
    }

    .distance-badge {
      display: inline-block;
      background: #4CAF50;
      color: white;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 11px;
      margin-left: 5px;
    }

    .image-row {
      display: flex;
      gap: 6px;
      justify-content: center;
      margin-top: 8px;
    }

    .image-row img {
      width: 30%;
      height: 70px;
      object-fit: cover;
      border-radius: 6px;
    }

    button {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      border: none;
      border-radius: 10px;
      font-weight: bold;
      cursor: pointer;
    }

    .book { background: black; color: white; }
    .reach { background: black; color: white; }
    .otpBtn { background: green; color: white; }
    .complete { background: red; color: white; }
    .cancel { background: #ff4444; color: white; }

    .button-row {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .button-row button {
      flex: 1;
      margin-top: 0;
    }

    .success {
      position: absolute;
      inset: 0;
      background: #f2f2f2;
      display: none;
      justify-content: center;
      align-items: center;
      overflow: hidden;
    }

    /* Straight Parking Animation Styles */
    .parking-container {
      position: relative;
      width: 280px;
      height: 400px;
    }

    .parking-slot {
      width: 70px;
      height: 120px;
      border: 4px solid;
      position: absolute;
      top: 80px;
      border-radius: 12px;
    }

    .slot-left { 
      left: 20px; 
      border-color: red; 
      background: rgba(255, 0, 0, 0.1);
    }
    
    .slot-middle { 
      left: 105px; 
      border-color: green; 
      background: rgba(0, 255, 0, 0.1);
    }
    
    .slot-right { 
      right: 20px; 
      border-color: red; 
      background: rgba(255, 0, 0, 0.1);
    }

    .parked-car-straight {
      width: 60px;
      height: 110px;
      position: absolute;
      font-size: 3em;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .left-parked { 
      top: 85px; 
      left: 25px; 
    }
    
    .right-parked { 
      top: 85px; 
      right: 25px; 
    }

    .moving-car {
      width: 60px;
      height: 110px;
      position: absolute;
      bottom: -150px;
      left: 110px;
      font-size: 3em;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .moving-car.park {
      animation: parkStraight 3s forwards ease-in-out;
    }

    @keyframes parkStraight {
      0% {
        bottom: -150px;
      }
      100% {
        bottom: 85px;
      }
    }

    .park-message {
      position: absolute;
      bottom: 30px;
      width: 100%;
      text-align: center;
      font-size: 18px;
      color: green;
      font-weight: bold;
      opacity: 0;
      transition: opacity 1s;
    }

    .park-message.show { 
      opacity: 1; 
    }
    .timer {
      font-size: 32px;
      font-weight: bold;
      margin-top: 10px;
    }

    /* Rating Popup */
    .rating-popup {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .rating-popup.active {
      display: flex;
    }

    .rating-card {
      background: white;
      padding: 30px;
      border-radius: 20px;
      width: 90%;
      max-width: 320px;
      text-align: center;
      animation: popIn 0.3s ease;
    }

    @keyframes popIn {
      0% { transform: scale(0.8); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }

    .rating-card h3 {
      color: #333;
      margin-bottom: 20px;
    }

    .stars {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 20px 0;
    }

    .star {
      font-size: 2.5em;
      cursor: pointer;
      transition: all 0.2s;
      filter: grayscale(1);
    }

    .star.active {
      filter: grayscale(0);
      transform: scale(1.2);
    }

    .star:hover {
      transform: scale(1.3);
    }

    .rating-card textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 10px;
      font-size: 14px;
      resize: none;
      margin: 15px 0;
      font-family: Arial, sans-serif;
    }

    .rating-card button {
      width: 100%;
      padding: 14px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 10px;
    }

    .rating-card button:hover {
      background: #45a049;
    }

    .skip-btn {
      background: #999 !important;
      margin-top: 5px !important;
    }

    .skip-btn:hover {
      background: #777 !important;
    }

    /* Image Preview Modal */
    .image-modal {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.95);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }

    .image-modal.active {
      display: flex;
    }

    .image-modal img {
      max-width: 90%;
      max-height: 90%;
      border-radius: 10px;
      box-shadow: 0 10px 50px rgba(0,0,0,0.5);
    }

    .close-modal {
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: 2em;
      color: white;
      cursor: pointer;
      background: rgba(0,0,0,0.5);
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Rating Display */
    .rating-display {
      display: flex;
      align-items: center;
      gap: 5px;
      margin: 8px 0;
      font-size: 14px;
    }

    .rating-stars {
      color: #FFD700;
      font-size: 16px;
    }

    .rating-count {
      color: #666;
      font-size: 12px;
    }

    .reviews-section {
      margin-top: 15px;
      max-height: 200px;
      overflow-y: auto;
      text-align: left;
    }

    .review-item {
      background: #f5f5f5;
      padding: 10px;
      border-radius: 8px;
      margin: 8px 0;
      font-size: 12px;
    }

    .review-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
    }

    .review-user {
      font-weight: bold;
      color: #333;
    }

    .review-rating {
      color: #FFD700;
    }

    .review-comment {
      color: #666;
      line-height: 1.4;
    }

    .review-date {
      color: #999;
      font-size: 10px;
      margin-top: 5px;
    }
  </style>
</head>
<body>

<div class="phone">
  <!-- Location Picker Overlay -->
  <div class="location-picker" id="locationPicker">
    <h3>üìç Set Your Location</h3>
    <p>Drag the red marker to your desired location</p>
    <p id="selectedLocation">Lat: -, Lng: -</p>
    <button class="use-current-location" onclick="useCurrentLocation()">üìç Use My Current Location</button>
    <button class="search-btn" onclick="searchNearbyParking()">üîç Search Parking Within 5km</button>
  </div>

  <div id="map"></div>

  <div class="panel" id="infoPanel"></div>

  <div class="panel" id="statusPanel">
    <div id="statusText">Waiting for owner confirmation...</div>

    <button class="reach" id="directionBtn" style="display:none;" onclick="openDirections()">Get Directions</button>
    <button class="reach" id="reachBtn" style="display:none;" onclick="confirmReached()">I Reached Location</button>
    
    <button class="cancel" onclick="cancelBooking()">‚ùå Cancel Booking</button>
  </div>

  <div class="panel" id="otpPanel">
    <h3>Enter 4‚ÄëDigit OTP</h3>
    <p style="font-size: 12px; color: #666;">Ask the parking owner for the OTP code</p>
    <input id="otpInput" maxlength="4" style="width:100%;padding:10px;font-size:18px;" placeholder="Enter OTP">
    <button class="otpBtn" onclick="verifyOtp()">Verify & Start Parking</button>
    <button class="cancel" onclick="cancelBooking()">‚ùå Cancel</button>
  </div>

  <div class="success" id="successScreen">
    <div class="parking-container">
      <!-- Parking Slots -->
      <div class="parking-slot slot-left"></div>
      <div class="parking-slot slot-middle"></div>
      <div class="parking-slot slot-right"></div>
      
      <!-- Parked Cars (Orange) -->
      <div class="parked-car-straight left-parked">üöó</div>
      <div class="parked-car-straight right-parked">üöó</div>
      
      <!-- Moving Car (Green) -->
      <div class="moving-car" id="movingCar">üöó</div>
      
      <!-- Success Message -->
      <div class="park-message" id="parkMessage">Car parked safely in ASP</div>
    </div>
  </div>

  <div class="panel" id="timerPanel">
    <h3>Parking Active</h3>
    <div class="timer" id="timer">00:00:00</div>
    <div style="font-size: 14px; color: #666; margin: 10px 0;">
      <span id="currentCost">‚Çπ0</span> ‚Ä¢ <span id="elapsedTime">0 min</span>
    </div>
    <button class="complete" onclick="confirmComplete()">Complete Parking & Pay</button>
    <h3 id="priceText"></h3>
  </div>

  <!-- Rating Popup -->
  <div class="rating-popup" id="ratingPopup">
    <div class="rating-card">
      <h3>‚≠ê Rate Your Experience</h3>
      <p style="font-size: 14px; color: #666;">How was your parking experience?</p>
      
      <div class="stars" id="ratingStars">
        <span class="star" onclick="setRating(1)">‚≠ê</span>
        <span class="star" onclick="setRating(2)">‚≠ê</span>
        <span class="star" onclick="setRating(3)">‚≠ê</span>
        <span class="star" onclick="setRating(4)">‚≠ê</span>
        <span class="star" onclick="setRating(5)">‚≠ê</span>
      </div>
      
      <textarea id="reviewComment" placeholder="Share your experience (optional)" rows="3"></textarea>
      
      <button onclick="submitRating()">Submit Rating</button>
      <button class="skip-btn" onclick="skipRating()">Skip</button>
    </div>
  </div>

  <!-- Image Preview Modal -->
  <div class="image-modal" id="imageModal" onclick="closeImageModal()">
    <div class="close-modal">√ó</div>
    <img id="modalImage" src="" alt="Preview">
  </div>
</div>

<script>
let map, currentBooking=null, startTime, timerInterval;
let searchMarker, userLocation = null;
let parkingMarkers = [];

function initMap(){
  // Default center (Kerala, India)
  const defaultCenter = {lat:9.9312, lng:76.2673};
  
  map=new google.maps.Map(document.getElementById("map"),{
    center: defaultCenter,
    zoom: 14
  });

  // Create draggable location marker with emoji
  searchMarker = new google.maps.Marker({
    position: defaultCenter,
    map: map,
    draggable: true,
    icon: {
      url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(
        '<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 48 48">' +
        '<text x="24" y="36" font-size="40" text-anchor="middle">üìç</text>' +
        '</svg>'
      ),
      scaledSize: new google.maps.Size(48, 48),
      anchor: new google.maps.Point(24, 48)
    },
    title: "Drag me to your location"
  });

  // Update location display when marker is dragged
  searchMarker.addListener('dragend', function() {
    const pos = searchMarker.getPosition();
    userLocation = {lat: pos.lat(), lng: pos.lng()};
    updateLocationDisplay();
  });

  // Set initial location
  userLocation = defaultCenter;
  updateLocationDisplay();

  // Try to get user's current location
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (position) => {
        const pos = {
          lat: position.coords.latitude,
          lng: position.coords.longitude
        };
        map.setCenter(pos);
        searchMarker.setPosition(pos);
        userLocation = pos;
        updateLocationDisplay();
      },
      () => {
        console.log("Geolocation permission denied");
      }
    );
  }

  watchBookingStatus();
}

function updateLocationDisplay() {
  if (userLocation) {
    document.getElementById('selectedLocation').innerText = 
      `Lat: ${userLocation.lat.toFixed(4)}, Lng: ${userLocation.lng.toFixed(4)}`;
  }
}

function useCurrentLocation() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (position) => {
        const pos = {
          lat: position.coords.latitude,
          lng: position.coords.longitude
        };
        map.setCenter(pos);
        searchMarker.setPosition(pos);
        userLocation = pos;
        updateLocationDisplay();
        alert("Location updated to your current position!");
      },
      () => {
        alert("Unable to get your location. Please drag the marker manually.");
      }
    );
  } else {
    alert("Geolocation is not supported by your browser.");
  }
}

function searchNearbyParking() {
  if (!userLocation) {
    alert("Please set your location first!");
    return;
  }

  // Hide location picker
  document.getElementById('locationPicker').style.display = 'none';

  // Clear existing parking markers
  parkingMarkers.forEach(marker => marker.setMap(null));
  parkingMarkers = [];

  // Get selected vehicle type from localStorage
  const vehicleType = localStorage.getItem('selectedVehicle') || 'car';

  // Search for nearby parking with vehicle filter
  console.log("Searching near:", userLocation, "for vehicle:", vehicleType);
  
  fetch(getApiUrl(`/api/parking/nearby?lat=${userLocation.lat}&lng=${userLocation.lng}&radius=5000&vehicleType=${vehicleType}`))
    .then(r => r.json())
    .then(data => {
      console.log(`Found ${data.length} parking spaces within 5km for ${vehicleType}`);
      
      if (data.length === 0) {
        alert(`No parking spaces found within 5km that accommodate ${vehicleType}. Try a different location or vehicle type.`);
        document.getElementById('locationPicker').style.display = 'block';
        return;
      }

      data.forEach(spot => {
        const pos = {lat: spot.location.coordinates[1], lng: spot.location.coordinates[0]};
        
        const marker = new google.maps.Marker({
          position: pos,
          map: map,
          icon: {
            url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(
              '<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 48 48">' +
              '<text x="24" y="36" font-size="40" text-anchor="middle">üÖøÔ∏è</text>' +
              '</svg>'
            ),
            scaledSize: new google.maps.Size(48, 48),
            anchor: new google.maps.Point(24, 48)
          },
          title: `${spot.ownerName} - ‚Çπ${spot.price}/hr - ${spot.distance}km away`
        });
        
        marker.addListener("click", () => showParkingInfo(spot));
        parkingMarkers.push(marker);
      });

      // Fit map to show all markers
      const bounds = new google.maps.LatLngBounds();
      bounds.extend(searchMarker.getPosition());
      parkingMarkers.forEach(marker => bounds.extend(marker.getPosition()));
      map.fitBounds(bounds);
    })
    .catch(err => {
      console.error("Search error:", err);
      alert("Error searching for parking. Please try again.");
    });
}

function loadParkingSpots(){
  // This function is now replaced by searchNearbyParking
  // Keeping it for compatibility
}

function showParkingInfo(spot){
  console.log("Showing parking info:", spot);
  console.log("Images:", spot.images);
  
  // Get reviews for this parking
  fetch(getApiUrl(`/api/reviews/parking/${spot._id}`))
    .then(r => r.json())
    .then(reviews => {
      const images = spot.images && spot.images.length > 0 
        ? spot.images.map(img => {
            const imgUrl = getApiUrl(img);
            console.log("Image URL:", imgUrl);
            return `<img src="${imgUrl}" style="width:30%;height:70px;object-fit:cover;border-radius:6px;cursor:pointer;" onclick="openImageModal('${imgUrl}')" onerror="console.error('Failed to load image:', this.src)">`;
          }).join('')
        : '<p style="font-size:12px;color:#666;">No images available</p>';
      
      // Display rating
      const ratingStars = spot.averageRating ? '‚≠ê'.repeat(Math.round(spot.averageRating)) : 'No ratings yet';
      const ratingText = spot.averageRating ? `${spot.averageRating} (${spot.totalReviews} reviews)` : '';
      
      // Display recent reviews
      const reviewsHtml = reviews.length > 0 
        ? `<div class="reviews-section">
            <h4 style="margin: 10px 0; font-size: 14px;">Recent Reviews:</h4>
            ${reviews.slice(0, 3).map(review => `
              <div class="review-item">
                <div class="review-header">
                  <span class="review-user">${review.userName}</span>
                  <span class="review-rating">${'‚≠ê'.repeat(review.rating)}</span>
                </div>
                ${review.comment ? `<div class="review-comment">${review.comment}</div>` : ''}
                <div class="review-date">${new Date(review.createdAt).toLocaleDateString()}</div>
              </div>
            `).join('')}
          </div>`
        : '';
      
      infoPanel.innerHTML=`
        <b>üë§ ${spot.ownerName}</b>
        <span class="distance-badge">üìç ${spot.distance || '?'} km away</span><br>
        <b>üí∞ ‚Çπ${spot.price}/hour</b><br>
        <div class="rating-display">
          <span class="rating-stars">${ratingStars}</span>
          <span class="rating-count">${ratingText}</span>
        </div>
        <p style="font-size:12px;margin:8px 0;color:#666;">${spot.notes || 'No description'}</p>
        <div style="display:flex;gap:6px;justify-content:center;margin:8px 0;flex-wrap:wrap;">
          ${images}
        </div>
        ${reviewsHtml}
        <button class='book' onclick="preBook('${spot._id}', ${spot.price})">Pre‚ÄëBook</button>
        <button class='cancel' onclick="closeInfo()">Close</button>`;
      infoPanel.style.display="block";
    })
    .catch(err => {
      console.error('Error loading reviews:', err);
      // Show info without reviews if error
      const images = spot.images && spot.images.length > 0 
        ? spot.images.map(img => {
            const imgUrl = getApiUrl(img);
            return `<img src="${imgUrl}" style="width:30%;height:70px;object-fit:cover;border-radius:6px;cursor:pointer;" onclick="openImageModal('${imgUrl}')">`;
          }).join('')
        : '<p style="font-size:12px;color:#666;">No images available</p>';
      
      infoPanel.innerHTML=`
        <b>üë§ ${spot.ownerName}</b>
        <span class="distance-badge">üìç ${spot.distance || '?'} km away</span><br>
        <b>üí∞ ‚Çπ${spot.price}/hour</b><br>
        <p style="font-size:12px;margin:8px 0;color:#666;">${spot.notes || 'No description'}</p>
        <div style="display:flex;gap:6px;justify-content:center;margin:8px 0;flex-wrap:wrap;">
          ${images}
        </div>
        <button class='book' onclick="preBook('${spot._id}', ${spot.price})">Pre‚ÄëBook</button>
        <button class='cancel' onclick="closeInfo()">Close</button>`;
      infoPanel.style.display="block";
    });
}

function closeInfo() {
  infoPanel.style.display="none";
}

function preBook(parkingId, price){
  const userId=localStorage.getItem("ownerId");

  fetch(getApiUrl("/api/booking/create"),{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({parkingId, userId, price})
  }).then(()=>{
    infoPanel.style.display="none";
    statusPanel.style.display="block";
  });
}

function watchBookingStatus(){
  const userId=localStorage.getItem("ownerId");

  setInterval(async()=>{
    const res=await fetch(getApiUrl(`/api/booking/driver/${userId}`));
    const b=await res.json();

    if(!b){ 
      statusPanel.style.display="none";
      otpPanel.style.display="none";
      timerPanel.style.display="none";
      return; 
    }

    currentBooking=b;

    if(b.status==="pending"){
      statusPanel.style.display="block";
      statusText.innerText="‚è≥ Waiting for owner confirmation...";
      directionBtn.style.display="none";
      reachBtn.style.display="none";
    }

    if(b.status==="confirmed"){
      statusPanel.style.display="block";
      statusText.innerText="‚úÖ Booking confirmed! Get directions to parking.";
      directionBtn.style.display="block";
    }

    if(b.status==="active"){
      statusPanel.style.display="none";
      otpPanel.style.display="none";
      if(!timerInterval) startParkingTimer();
    }

  },3000);
}

// Cancel booking function
function cancelBooking(){
  if(!confirm("Are you sure you want to cancel this booking?")) return;
  
  if(!currentBooking) return;
  
  fetch(getApiUrl(`/api/booking/cancel/${currentBooking._id}`),{
    method:"POST"
  })
  .then(()=>{
    alert("Booking cancelled successfully");
    currentBooking=null;
    statusPanel.style.display="none";
    otpPanel.style.display="none";
    timerPanel.style.display="none";
    if(timerInterval) clearInterval(timerInterval);
  })
  .catch(err=>{
    console.error("Cancel error:", err);
    alert("Failed to cancel booking");
  });
}

function openDirections(){
  const coords=currentBooking.parking.location.coordinates;
  window.open(`https://www.google.com/maps/dir/?api=1&destination=${coords[1]},${coords[0]}`);
  directionBtn.style.display="none";
  reachBtn.style.display="block";
}

function confirmReached(){
  if(!confirm("Did you reach correct parking location?")) return;
  statusPanel.style.display="none";
  otpPanel.style.display="block";
}

function verifyOtp(){
  const otp=otpInput.value;

  fetch(getApiUrl(`/api/booking/verify-otp/${currentBooking._id}`),{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({otp})
  })
  .then(r=>r.json())
  .then(d=>{
    if(!d.success) return alert("Wrong OTP");

    otpPanel.style.display="none";
    successScreen.style.display="flex";

    // Start parking animation
    setTimeout(() => {
      document.getElementById('movingCar').classList.add('park');
    }, 500);

    // Show success message
    setTimeout(() => {
      document.getElementById('parkMessage').classList.add('show');
    }, 3500);

    // Hide success screen and start timer
    setTimeout(()=>{
      successScreen.style.display="none";
      startParkingTimer();
    }, 6000);
  });
}

function startParkingTimer(){
  if(timerInterval) return; // Prevent multiple timers
  
  timerPanel.style.display="block";
  startTime=Date.now();
  
  // Get price from current booking's parking space
  const pricePerHour = currentBooking?.parking?.price || currentBooking?.price || 50;
  
  console.log("Starting timer with price per hour:", pricePerHour);

  timerInterval=setInterval(()=>{
    const diff=Date.now()-startTime;
    const h=Math.floor(diff/3600000);
    const m=Math.floor((diff%3600000)/60000);
    const s=Math.floor((diff%60000)/1000);
    
    // Update timer display (HH:MM:SS)
    timer.innerText=String(h).padStart(2,'0')+":"+String(m).padStart(2,'0')+":"+String(s).padStart(2,'0');
    
    // Calculate cost based on actual minutes (not rounded hours)
    const totalMinutes = Math.ceil(diff/60000);
    const pricePerMinute = pricePerHour / 60;
    const currentCost = Math.round(totalMinutes * pricePerMinute);
    
    // Update cost display
    document.getElementById('currentCost').innerText = `‚Çπ${currentCost}`;
    document.getElementById('elapsedTime').innerText = `${totalMinutes} min`;
  },1000);
}

function confirmComplete(){
  const diff=Date.now()-startTime;
  const totalMinutes=Math.ceil(diff/60000);
  
  // Use provider's actual price and calculate per minute
  const pricePerHour = currentBooking?.parking?.price || currentBooking?.price || 50;
  const pricePerMinute = pricePerHour / 60;
  const total = Math.round(totalMinutes * pricePerMinute);

  console.log("Completing payment:", { totalMinutes, pricePerHour, pricePerMinute, total });

  if(!confirm(`Confirm departure?\n\nTime: ${totalMinutes} minutes\nPrice: ‚Çπ${pricePerHour}/hour (‚Çπ${pricePerMinute.toFixed(2)}/min)\nTotal Amount: ‚Çπ${total}`)) return;

  completePayment(total, totalMinutes);
}

async function completePayment(total, minutes) {
  try {
    console.log("Starting payment process...", { total, minutes, bookingId: currentBooking._id });
    
    // Create Razorpay order
    const res = await fetch(getApiUrl("/api/payment/create-order"), {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ 
        bookingId: currentBooking._id, 
        amount: total 
      })
    });

    console.log("Order response status:", res.status);
    const orderData = await res.json();
    console.log("Order data received:", orderData);
    
    if (!orderData.orderId) {
      console.error("No orderId in response:", orderData);
      alert("Failed to create payment order: " + (orderData.error || "Unknown error"));
      return;
    }

    console.log("Opening Razorpay with key:", orderData.keyId);

    // Razorpay payment options
    const options = {
      key: orderData.keyId,
      amount: orderData.amount,
      currency: orderData.currency,
      name: "ASP - A Space for Park",
      description: `Parking Payment - ${minutes} minutes`,
      order_id: orderData.orderId,
      handler: async function (response) {
        console.log("Payment successful, verifying...", response);
        
        // Verify payment
        const verifyRes = await fetch(getApiUrl("/api/payment/verify"), {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            razorpay_order_id: response.razorpay_order_id,
            razorpay_payment_id: response.razorpay_payment_id,
            razorpay_signature: response.razorpay_signature
          })
        });

        const verifyData = await verifyRes.json();
        console.log("Verification result:", verifyData);

        if (verifyData.success) {
          console.log("Payment verified, completing booking...");
          
          // Complete booking
          await fetch(getApiUrl(`/api/payment/complete/${currentBooking._id}`), {
            method: "POST"
          });

          clearInterval(timerInterval);
          priceText.innerText = `‚úÖ Payment Success!\nTime: ${minutes} min\nPaid: ‚Çπ${total}`;
          
          // Show rating popup after 2 seconds
          setTimeout(() => {
            timerPanel.style.display = 'none';
            document.getElementById('ratingPopup').classList.add('active');
          }, 2000);
        } else {
          console.error("Payment verification failed:", verifyData);
          alert("Payment verification failed: " + (verifyData.error || "Unknown error"));
        }
      },
      prefill: {
        name: localStorage.getItem("name") || "User",
        email: localStorage.getItem("email") || "",
      },
      theme: {
        color: "#FFD400"
      },
      modal: {
        ondismiss: function() {
          console.log("Payment cancelled by user");
          alert("Payment cancelled");
        }
      }
    };

    console.log("Initializing Razorpay...");
    const rzp = new Razorpay(options);
    rzp.open();
    console.log("Razorpay popup opened");

  } catch (err) {
    console.error("Payment error:", err);
    alert("Payment failed: " + err.message);
  }
}

// Rating System
let selectedRating = 0;

function setRating(rating) {
  selectedRating = rating;
  const stars = document.querySelectorAll('.star');
  stars.forEach((star, index) => {
    if (index < rating) {
      star.classList.add('active');
    } else {
      star.classList.remove('active');
    }
  });
}

function submitRating() {
  if (selectedRating === 0) {
    alert('Please select a rating');
    return;
  }

  const comment = document.getElementById('reviewComment').value;
  const userId = localStorage.getItem('ownerId');
  const userName = localStorage.getItem('name');

  fetch(getApiUrl('/api/reviews/submit'), {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      parkingId: currentBooking.parkingId || currentBooking.parking._id,
      userId: userId,
      userName: userName,
      rating: selectedRating,
      comment: comment,
      bookingId: currentBooking._id
    })
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      alert('Thank you for your rating!');
      document.getElementById('ratingPopup').classList.remove('active');
      window.location.href = 'dashboard.html';
    } else {
      alert(data.error || 'Failed to submit rating');
    }
  })
  .catch(err => {
    console.error('Rating error:', err);
    alert('Failed to submit rating');
  });
}

function skipRating() {
  if (confirm('Are you sure you want to skip rating?')) {
    document.getElementById('ratingPopup').classList.remove('active');
    window.location.href = 'dashboard.html';
  }
}

// Image Preview
function openImageModal(imageSrc) {
  document.getElementById('modalImage').src = imageSrc;
  document.getElementById('imageModal').classList.add('active');
}

function closeImageModal() {
  document.getElementById('imageModal').classList.remove('active');
}
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAzFgFejKDyyFfXqdOfaKmjPiAmXVHHZS4&callback=initMap" async defer></script>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

</body>
</html>