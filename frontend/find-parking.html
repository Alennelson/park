<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Find Parking Near You - Parkify | Book Parking Spaces Online</title>
  <meta name="description" content="Find and book available parking spaces near your location. Real-time parking availability, secure booking, and instant confirmation.">
  <meta name="keywords" content="find parking, parking near me, book parking online, available parking, parking map, parking spaces">
  <meta name="robots" content="index, follow">
  <link rel="canonical" href="https://www.alen.club/find-parking.html">
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://www.alen.club/find-parking.html">
  <meta property="og:title" content="Find Parking Near You - Parkify">
  <meta property="og:description" content="Find and book available parking spaces near your location. Real-time parking availability.">
  <meta property="og:image" content="https://www.alen.club/og-image.jpg">
  
  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:url" content="https://www.alen.club/find-parking.html">
  <meta property="twitter:title" content="Find Parking Near You - Parkify">
  <meta property="twitter:description" content="Find and book available parking spaces near your location.">
  <meta property="twitter:image" content="https://www.alen.club/og-image.jpg">
  
  <script src="config.js"></script>

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #FFD400;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }

    .phone {
      width: 360px;
      height: 700px;
      border-radius: 30px;
      overflow: hidden;
      box-shadow: 0 20px 50px rgba(0,0,0,0.4);
      position: relative;
      background: white;
    }

    #map { width: 100%; height: 100%; }

    /* Location Picker Overlay */
    .location-picker {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      background: white;
      padding: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      z-index: 1000;
    }

    .location-picker h3 {
      margin: 0 0 10px 0;
      font-size: 16px;
    }

    .location-picker p {
      margin: 5px 0;
      font-size: 12px;
      color: #666;
    }

    .search-btn {
      width: 100%;
      padding: 12px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 10px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 10px;
    }

    .use-current-location {
      width: 100%;
      padding: 10px;
      background: #2196F3;
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      cursor: pointer;
      margin-top: 5px;
    }

    .panel {
      position: absolute;
      bottom: 0;
      width: 100%;
      background: #fff;
      padding: 15px;
      text-align: center;
      display: none;
      box-shadow: 0 -5px 15px rgba(0,0,0,0.2);
      max-height: 300px;
      overflow-y: auto;
    }

    .distance-badge {
      display: inline-block;
      background: #4CAF50;
      color: white;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 11px;
      margin-left: 5px;
    }

    .image-row {
      display: flex;
      gap: 6px;
      justify-content: center;
      margin-top: 8px;
    }

    .image-row img {
      width: 30%;
      height: 70px;
      object-fit: cover;
      border-radius: 6px;
    }

    button {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      border: none;
      border-radius: 10px;
      font-weight: bold;
      cursor: pointer;
    }

    .book { background: black; color: white; }
    .reach { background: black; color: white; }
    .otpBtn { background: green; color: white; }
    .complete { background: red; color: white; }
    .cancel { background: #ff4444; color: white; }

    .button-row {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .button-row button {
      flex: 1;
      margin-top: 0;
    }

    .success {
      position: absolute;
      inset: 0;
      background: white;
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .car { font-size: 60px; }

    .timer {
      font-size: 32px;
      font-weight: bold;
      margin-top: 10px;
    }
  </style>
</head>
<body>

<div class="phone">
  <!-- Location Picker Overlay -->
  <div class="location-picker" id="locationPicker">
    <h3>üìç Set Your Location</h3>
    <p>Drag the red marker to your desired location</p>
    <p id="selectedLocation">Lat: -, Lng: -</p>
    <button class="use-current-location" onclick="useCurrentLocation()">üìç Use My Current Location</button>
    <button class="search-btn" onclick="searchNearbyParking()">üîç Search Parking Within 5km</button>
  </div>

  <div id="map"></div>

  <div class="panel" id="infoPanel"></div>

  <div class="panel" id="statusPanel">
    <div id="statusText">Waiting for owner confirmation...</div>

    <button class="reach" id="directionBtn" style="display:none;" onclick="openDirections()">Get Directions</button>
    <button class="reach" id="reachBtn" style="display:none;" onclick="confirmReached()">I Reached Location</button>
    
    <button class="cancel" onclick="cancelBooking()">‚ùå Cancel Booking</button>
  </div>

  <div class="panel" id="otpPanel">
    <h3>Enter 4‚ÄëDigit OTP</h3>
    <p style="font-size: 12px; color: #666;">Ask the parking owner for the OTP code</p>
    <input id="otpInput" maxlength="4" style="width:100%;padding:10px;font-size:18px;" placeholder="Enter OTP">
    <button class="otpBtn" onclick="verifyOtp()">Verify & Start Parking</button>
    <button class="cancel" onclick="cancelBooking()">‚ùå Cancel</button>
  </div>

  <div class="success" id="successScreen">
    <div class="car">üöó</div>
    <h3>Car parked safely in ASP</h3>
  </div>

  <div class="panel" id="timerPanel">
    <h3>Parking Active</h3>
    <div class="timer" id="timer">00:00:00</div>
    <div style="font-size: 14px; color: #666; margin: 10px 0;">
      <span id="currentCost">‚Çπ0</span> ‚Ä¢ <span id="elapsedTime">0 min</span>
    </div>
    <button class="complete" onclick="confirmComplete()">Complete Parking & Pay</button>
    <h3 id="priceText"></h3>
  </div>
</div>

<script>
let map, currentBooking=null, startTime, timerInterval;
let searchMarker, userLocation = null;
let parkingMarkers = [];

function initMap(){
  // Default center (Kerala, India)
  const defaultCenter = {lat:9.9312, lng:76.2673};
  
  map=new google.maps.Map(document.getElementById("map"),{
    center: defaultCenter,
    zoom: 14
  });

  // Create draggable location marker with emoji
  searchMarker = new google.maps.Marker({
    position: defaultCenter,
    map: map,
    draggable: true,
    icon: {
      url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(
        '<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 48 48">' +
        '<text x="24" y="36" font-size="40" text-anchor="middle">üìç</text>' +
        '</svg>'
      ),
      scaledSize: new google.maps.Size(48, 48),
      anchor: new google.maps.Point(24, 48)
    },
    title: "Drag me to your location"
  });

  // Update location display when marker is dragged
  searchMarker.addListener('dragend', function() {
    const pos = searchMarker.getPosition();
    userLocation = {lat: pos.lat(), lng: pos.lng()};
    updateLocationDisplay();
  });

  // Set initial location
  userLocation = defaultCenter;
  updateLocationDisplay();

  // Try to get user's current location
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (position) => {
        const pos = {
          lat: position.coords.latitude,
          lng: position.coords.longitude
        };
        map.setCenter(pos);
        searchMarker.setPosition(pos);
        userLocation = pos;
        updateLocationDisplay();
      },
      () => {
        console.log("Geolocation permission denied");
      }
    );
  }

  watchBookingStatus();
}

function updateLocationDisplay() {
  if (userLocation) {
    document.getElementById('selectedLocation').innerText = 
      `Lat: ${userLocation.lat.toFixed(4)}, Lng: ${userLocation.lng.toFixed(4)}`;
  }
}

function useCurrentLocation() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (position) => {
        const pos = {
          lat: position.coords.latitude,
          lng: position.coords.longitude
        };
        map.setCenter(pos);
        searchMarker.setPosition(pos);
        userLocation = pos;
        updateLocationDisplay();
        alert("Location updated to your current position!");
      },
      () => {
        alert("Unable to get your location. Please drag the marker manually.");
      }
    );
  } else {
    alert("Geolocation is not supported by your browser.");
  }
}

function searchNearbyParking() {
  if (!userLocation) {
    alert("Please set your location first!");
    return;
  }

  // Hide location picker
  document.getElementById('locationPicker').style.display = 'none';

  // Clear existing parking markers
  parkingMarkers.forEach(marker => marker.setMap(null));
  parkingMarkers = [];

  // Search for nearby parking
  console.log("Searching near:", userLocation);
  
  fetch(getApiUrl(`/api/parking/nearby?lat=${userLocation.lat}&lng=${userLocation.lng}&radius=5000`))
    .then(r => r.json())
    .then(data => {
      console.log(`Found ${data.length} parking spaces within 5km`);
      
      if (data.length === 0) {
        alert("No parking spaces found within 5km. Try a different location.");
        document.getElementById('locationPicker').style.display = 'block';
        return;
      }

      data.forEach(spot => {
        const pos = {lat: spot.location.coordinates[1], lng: spot.location.coordinates[0]};
        
        const marker = new google.maps.Marker({
          position: pos,
          map: map,
          icon: {
            url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(
              '<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 48 48">' +
              '<text x="24" y="36" font-size="40" text-anchor="middle">üÖøÔ∏è</text>' +
              '</svg>'
            ),
            scaledSize: new google.maps.Size(48, 48),
            anchor: new google.maps.Point(24, 48)
          },
          title: `${spot.ownerName} - ‚Çπ${spot.price}/hr - ${spot.distance}km away`
        });
        
        marker.addListener("click", () => showParkingInfo(spot));
        parkingMarkers.push(marker);
      });

      // Fit map to show all markers
      const bounds = new google.maps.LatLngBounds();
      bounds.extend(searchMarker.getPosition());
      parkingMarkers.forEach(marker => bounds.extend(marker.getPosition()));
      map.fitBounds(bounds);
    })
    .catch(err => {
      console.error("Search error:", err);
      alert("Error searching for parking. Please try again.");
    });
}

function loadParkingSpots(){
  // This function is now replaced by searchNearbyParking
  // Keeping it for compatibility
}

function showParkingInfo(spot){
  console.log("Showing parking info:", spot);
  console.log("Images:", spot.images);
  
  const images = spot.images && spot.images.length > 0 
    ? spot.images.map(img => {
        const imgUrl = getApiUrl(img);
        console.log("Image URL:", imgUrl);
        return `<img src="${imgUrl}" style="width:30%;height:70px;object-fit:cover;border-radius:6px;" onerror="console.error('Failed to load image:', this.src)">`;
      }).join('')
    : '<p style="font-size:12px;color:#666;">No images available</p>';
  
  infoPanel.innerHTML=`
    <b>üë§ ${spot.ownerName}</b>
    <span class="distance-badge">üìç ${spot.distance || '?'} km away</span><br>
    <b>üí∞ ‚Çπ${spot.price}/hour</b><br>
    <p style="font-size:12px;margin:8px 0;color:#666;">${spot.notes || 'No description'}</p>
    <div style="display:flex;gap:6px;justify-content:center;margin:8px 0;flex-wrap:wrap;">
      ${images}
    </div>
    <button class='book' onclick="preBook('${spot._id}', ${spot.price})">Pre‚ÄëBook</button>
    <button class='cancel' onclick="closeInfo()">Close</button>`;
  infoPanel.style.display="block";
}

function closeInfo() {
  infoPanel.style.display="none";
}

function preBook(parkingId, price){
  const userId=localStorage.getItem("ownerId");

  fetch(getApiUrl("/api/booking/create"),{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({parkingId, userId, price})
  }).then(()=>{
    infoPanel.style.display="none";
    statusPanel.style.display="block";
  });
}

function watchBookingStatus(){
  const userId=localStorage.getItem("ownerId");

  setInterval(async()=>{
    const res=await fetch(getApiUrl(`/api/booking/driver/${userId}`));
    const b=await res.json();

    if(!b){ 
      statusPanel.style.display="none";
      otpPanel.style.display="none";
      timerPanel.style.display="none";
      return; 
    }

    currentBooking=b;

    if(b.status==="pending"){
      statusPanel.style.display="block";
      statusText.innerText="‚è≥ Waiting for owner confirmation...";
      directionBtn.style.display="none";
      reachBtn.style.display="none";
    }

    if(b.status==="confirmed"){
      statusPanel.style.display="block";
      statusText.innerText="‚úÖ Booking confirmed! Get directions to parking.";
      directionBtn.style.display="block";
    }

    if(b.status==="active"){
      statusPanel.style.display="none";
      otpPanel.style.display="none";
      if(!timerInterval) startParkingTimer();
    }

  },3000);
}

// Cancel booking function
function cancelBooking(){
  if(!confirm("Are you sure you want to cancel this booking?")) return;
  
  if(!currentBooking) return;
  
  fetch(getApiUrl(`/api/booking/cancel/${currentBooking._id}`),{
    method:"POST"
  })
  .then(()=>{
    alert("Booking cancelled successfully");
    currentBooking=null;
    statusPanel.style.display="none";
    otpPanel.style.display="none";
    timerPanel.style.display="none";
    if(timerInterval) clearInterval(timerInterval);
  })
  .catch(err=>{
    console.error("Cancel error:", err);
    alert("Failed to cancel booking");
  });
}

function openDirections(){
  const coords=currentBooking.parking.location.coordinates;
  window.open(`https://www.google.com/maps/dir/?api=1&destination=${coords[1]},${coords[0]}`);
  directionBtn.style.display="none";
  reachBtn.style.display="block";
}

function confirmReached(){
  if(!confirm("Did you reach correct parking location?")) return;
  statusPanel.style.display="none";
  otpPanel.style.display="block";
}

function verifyOtp(){
  const otp=otpInput.value;

  fetch(getApiUrl(`/api/booking/verify-otp/${currentBooking._id}`),{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({otp})
  })
  .then(r=>r.json())
  .then(d=>{
    if(!d.success) return alert("Wrong OTP");

    otpPanel.style.display="none";
    successScreen.style.display="flex";

    setTimeout(()=>{
      successScreen.style.display="none";
      startParkingTimer();
    },2000);
  });
}

function startParkingTimer(){
  if(timerInterval) return; // Prevent multiple timers
  
  timerPanel.style.display="block";
  startTime=Date.now();
  
  // Get price from current booking's parking space
  const pricePerHour = currentBooking?.parking?.price || currentBooking?.price || 50;
  
  console.log("Starting timer with price per hour:", pricePerHour);

  timerInterval=setInterval(()=>{
    const diff=Date.now()-startTime;
    const h=Math.floor(diff/3600000);
    const m=Math.floor((diff%3600000)/60000);
    const s=Math.floor((diff%60000)/1000);
    
    // Update timer display (HH:MM:SS)
    timer.innerText=String(h).padStart(2,'0')+":"+String(m).padStart(2,'0')+":"+String(s).padStart(2,'0');
    
    // Calculate cost based on provider's price
    const totalMinutes = Math.ceil(diff/60000);
    const totalHours = Math.ceil(totalMinutes/60);
    const currentCost = totalHours * pricePerHour;
    
    // Update cost display
    document.getElementById('currentCost').innerText = `‚Çπ${currentCost}`;
    document.getElementById('elapsedTime').innerText = `${totalMinutes} min`;
  },1000);
}

function confirmComplete(){
  const diff=Date.now()-startTime;
  const totalMinutes=Math.ceil(diff/60000);
  const totalHours=Math.ceil(totalMinutes/60);
  
  // Use provider's actual price
  const pricePerHour = currentBooking?.parking?.price || currentBooking?.price || 50;
  const total = totalHours * pricePerHour;

  console.log("Completing payment:", { totalMinutes, totalHours, pricePerHour, total });

  if(!confirm(`Confirm departure?\n\nTime: ${totalMinutes} minutes (${totalHours} hour${totalHours>1?'s':''})\nPrice: ‚Çπ${pricePerHour}/hour\nTotal Amount: ‚Çπ${total}`)) return;

  completePayment(total, totalMinutes);
}

async function completePayment(total, minutes) {
  try {
    console.log("Starting payment process...", { total, minutes, bookingId: currentBooking._id });
    
    // Create Razorpay order
    const res = await fetch(getApiUrl("/api/payment/create-order"), {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ 
        bookingId: currentBooking._id, 
        amount: total 
      })
    });

    console.log("Order response status:", res.status);
    const orderData = await res.json();
    console.log("Order data received:", orderData);
    
    if (!orderData.orderId) {
      console.error("No orderId in response:", orderData);
      alert("Failed to create payment order: " + (orderData.error || "Unknown error"));
      return;
    }

    console.log("Opening Razorpay with key:", orderData.keyId);

    // Razorpay payment options
    const options = {
      key: orderData.keyId,
      amount: orderData.amount,
      currency: orderData.currency,
      name: "Parkify",
      description: `Parking Payment - ${minutes} minutes`,
      order_id: orderData.orderId,
      handler: async function (response) {
        console.log("Payment successful, verifying...", response);
        
        // Verify payment
        const verifyRes = await fetch(getApiUrl("/api/payment/verify"), {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            razorpay_order_id: response.razorpay_order_id,
            razorpay_payment_id: response.razorpay_payment_id,
            razorpay_signature: response.razorpay_signature
          })
        });

        const verifyData = await verifyRes.json();
        console.log("Verification result:", verifyData);

        if (verifyData.success) {
          console.log("Payment verified, completing booking...");
          
          // Complete booking
          await fetch(getApiUrl(`/api/payment/complete/${currentBooking._id}`), {
            method: "POST"
          });

          clearInterval(timerInterval);
          priceText.innerText = `‚úÖ Payment Success!\nTime: ${minutes} min\nPaid: ‚Çπ${total}`;
          
          setTimeout(() => {
            window.location.href = "dashboard.html";
          }, 3000);
        } else {
          console.error("Payment verification failed:", verifyData);
          alert("Payment verification failed: " + (verifyData.error || "Unknown error"));
        }
      },
      prefill: {
        name: localStorage.getItem("name") || "User",
        email: localStorage.getItem("email") || "",
      },
      theme: {
        color: "#FFD400"
      },
      modal: {
        ondismiss: function() {
          console.log("Payment cancelled by user");
          alert("Payment cancelled");
        }
      }
    };

    console.log("Initializing Razorpay...");
    const rzp = new Razorpay(options);
    rzp.open();
    console.log("Razorpay popup opened");

  } catch (err) {
    console.error("Payment error:", err);
    alert("Payment failed: " + err.message);
  }
}
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAzFgFejKDyyFfXqdOfaKmjPiAmXVHHZS4&callback=initMap" async defer></script>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

</body>
</html>