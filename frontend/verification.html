<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ASP Insurance Protection - Get Verified</title>
  <script src="config.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #FFD400 0%, #FFA500 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .header {
      text-align: center;
      color: white;
      margin-bottom: 40px;
    }
    
    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }
    
    .header p {
      font-size: 1.2em;
      opacity: 0.9;
    }
    
    .plans-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 30px;
      margin-bottom: 40px;
    }
    
    .plan-card {
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      transition: transform 0.3s, box-shadow 0.3s;
      position: relative;
      overflow: hidden;
    }
    
    .plan-card:hover {
      transform: translateY(-10px);
      box-shadow: 0 15px 40px rgba(0,0,0,0.3);
    }
    
    .plan-card.recommended {
      border: 3px solid #FFD400;
    }
    
    .plan-card.recommended::before {
      content: "RECOMMENDED";
      position: absolute;
      top: 15px;
      right: -35px;
      background: #FFD400;
      color: #000;
      padding: 5px 40px;
      transform: rotate(45deg);
      font-size: 12px;
      font-weight: bold;
    }
    
    .plan-badge {
      font-size: 3em;
      margin-bottom: 15px;
    }
    
    .plan-name {
      font-size: 1.8em;
      font-weight: bold;
      margin-bottom: 10px;
      color: #333;
    }
    
    .plan-price {
      font-size: 2.5em;
      font-weight: bold;
      color: #FFD400;
      margin-bottom: 5px;
    }
    
    .plan-period {
      color: #666;
      margin-bottom: 20px;
    }
    
    .plan-features {
      list-style: none;
      margin-bottom: 25px;
    }
    
    .plan-features li {
      padding: 10px 0;
      border-bottom: 1px solid #f0f0f0;
      color: #555;
    }
    
    .plan-features li:last-child {
      border-bottom: none;
    }
    
    .select-btn {
      width: 100%;
      padding: 15px;
      background: #000;
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 1.1em;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    .select-btn:hover {
      background: #333;
    }
    
    .select-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .current-status {
      background: white;
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }
    
    .status-badge {
      display: inline-block;
      padding: 10px 20px;
      border-radius: 25px;
      font-weight: bold;
      margin-bottom: 15px;
    }
    
    .status-badge.silver {
      background: #C0C0C0;
      color: white;
    }
    
    .status-badge.gold {
      background: #FFD700;
      color: #000;
    }
    
    .status-badge.platinum {
      background: linear-gradient(135deg, #E5E4E2 0%, #BCC6CC 100%);
      color: #000;
    }
    
    .back-btn {
      display: inline-block;
      padding: 12px 30px;
      background: white;
      color: #000;
      text-decoration: none;
      border-radius: 10px;
      font-weight: bold;
      margin-bottom: 20px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.2);
    }
    
    .back-btn:hover {
      background: #f0f0f0;
    }
  </style>
</head>
<body>

<div class="container">
  <a href="dashboard.html" class="back-btn">‚Üê Back to Dashboard</a>
  
  <div class="header">
    <h1>üõ°Ô∏è ASP Insurance Protection</h1>
    <p>Get verified and earn more with insurance-backed trust</p>
  </div>
  
  <div id="currentStatus" class="current-status" style="display:none;">
    <h2>Your Current Status</h2>
    <div id="statusContent"></div>
  </div>
  
  <div class="plans-grid">
    <!-- Silver Plan -->
    <div class="plan-card">
      <div class="plan-badge">ü•à</div>
      <div class="plan-name">Silver</div>
      <div class="plan-price">‚Çπ299</div>
      <div class="plan-period">per month</div>
      <ul class="plan-features">
        <li>‚úì Outer body damage coverage</li>
        <li>‚úì Scratches & minor dents</li>
        <li>‚úì Mirror damage</li>
        <li>‚úì Claim limit: ‚Çπ10,000</li>
        <li>‚úì Silver verified badge</li>
        <li>‚úì +5% price boost</li>
      </ul>
      <button class="select-btn" onclick="selectPlan('silver')">Select Silver</button>
    </div>
    
    <!-- Gold Plan -->
    <div class="plan-card recommended">
      <div class="plan-badge">ü•á</div>
      <div class="plan-name">Gold</div>
      <div class="plan-price">‚Çπ599</div>
      <div class="plan-period">per month</div>
      <ul class="plan-features">
        <li>‚úì All Silver benefits</li>
        <li>‚úì Glass damage coverage</li>
        <li>‚úì Minor electrical issues</li>
        <li>‚úì Claim limit: ‚Çπ25,000</li>
        <li>‚úì Gold verified badge</li>
        <li>‚úì Priority listing</li>
        <li>‚úì +10% price boost</li>
      </ul>
      <button class="select-btn" onclick="selectPlan('gold')">Select Gold</button>
    </div>
    
    <!-- Platinum Plan -->
    <div class="plan-card">
      <div class="plan-badge">üíé</div>
      <div class="plan-name">Platinum</div>
      <div class="plan-price">‚Çπ999</div>
      <div class="plan-period">per month</div>
      <ul class="plan-features">
        <li>‚úì All Gold benefits</li>
        <li>‚úì Major body damage</li>
        <li>‚úì Fire damage coverage</li>
        <li>‚úì Theft protection</li>
        <li>‚úì Claim limit: ‚Çπ50,000</li>
        <li>‚úì Platinum verified badge</li>
        <li>‚úì Top priority listing</li>
        <li>‚úì 24/7 claim support</li>
        <li>‚úì +15% price boost</li>
      </ul>
      <button class="select-btn" onclick="selectPlan('platinum')">Select Platinum</button>
    </div>
  </div>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
const ownerId = localStorage.getItem('ownerId');

// Load current verification status
async function loadStatus() {
  try {
    const res = await fetch(getApiUrl(`/api/verification/status/${ownerId}`));
    const data = await res.json();
    
    if (data.verified) {
      const statusDiv = document.getElementById('currentStatus');
      const statusContent = document.getElementById('statusContent');
      
      const tierBadges = {
        silver: 'ü•à Silver',
        gold: 'ü•á Gold',
        platinum: 'üíé Platinum'
      };
      
      const expiryDate = new Date(data.expiresAt).toLocaleDateString();
      
      statusContent.innerHTML = `
        <span class="status-badge ${data.tier}">${tierBadges[data.tier]} Verified</span>
        <p><strong>Expires:</strong> ${expiryDate}</p>
        <p><strong>Claim Limit:</strong> ‚Çπ${data.claimLimit.toLocaleString()}</p>
        <p><strong>Price Boost:</strong> +${data.priceBoost}%</p>
      `;
      
      statusDiv.style.display = 'block';
    }
  } catch (err) {
    console.error('Load status error:', err);
  }
}

async function selectPlan(tier) {
  if (!ownerId) {
    alert('Please login first');
    window.location.href = 'login.html';
    return;
  }
  
  console.log('Selecting plan:', tier, 'for owner:', ownerId);
  
  try {
    // Create order
    console.log('Creating order...');
    const orderRes = await fetch(getApiUrl('/api/verification/create-order'), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ ownerId, tier })
    });
    
    console.log('Order response status:', orderRes.status);
    const orderData = await orderRes.json();
    console.log('Order data:', orderData);
    
    if (!orderData.orderId) {
      console.error('No orderId in response:', orderData);
      alert('Failed to create order: ' + (orderData.error || 'Unknown error'));
      return;
    }
    
    console.log('Opening Razorpay with order:', orderData.orderId);
    
    // Open Razorpay
    const options = {
      key: orderData.keyId,
      amount: orderData.amount,
      currency: orderData.currency,
      name: "ASP Insurance Protection",
      description: `${tier.toUpperCase()} Verification Plan`,
      order_id: orderData.orderId,
      handler: async function (response) {
        console.log('Payment successful:', response);
        
        try {
          // Verify payment
          console.log('Verifying payment...');
          const verifyRes = await fetch(getApiUrl('/api/verification/verify-payment'), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              razorpay_order_id: response.razorpay_order_id,
              razorpay_payment_id: response.razorpay_payment_id,
              razorpay_signature: response.razorpay_signature,
              ownerId,
              tier
            })
          });
          
          console.log('Verify response status:', verifyRes.status);
          const verifyData = await verifyRes.json();
          console.log('Verify data:', verifyData);
          
          if (verifyData.success) {
            alert(`üéâ Congratulations! You are now ${tier.toUpperCase()} verified!\n\nYour badge will be visible to all drivers.\nYour prices have been automatically increased by ${tier === 'silver' ? '5' : tier === 'gold' ? '10' : '15'}%`);
            setTimeout(() => {
              window.location.href = 'dashboard.html';
            }, 2000);
          } else {
            console.error('Verification failed:', verifyData);
            alert('Payment verification failed: ' + (verifyData.error || 'Unknown error'));
          }
        } catch (verifyErr) {
          console.error('Verification error:', verifyErr);
          alert('Payment verification failed: ' + verifyErr.message);
        }
      },
      prefill: {
        name: localStorage.getItem("name") || "User",
        email: localStorage.getItem("email") || "",
      },
      theme: {
        color: "#FFD400"
      },
      modal: {
        ondismiss: function() {
          console.log('Payment cancelled by user');
        }
      }
    };
    
    const rzp = new Razorpay(options);
    rzp.open();
    console.log('Razorpay opened');
    
  } catch (err) {
    console.error('Payment error:', err);
    alert('Payment failed: ' + err.message);
  }
}

// Load status on page load
loadStatus();
</script>

</body>
</html>
