<!DOCTYPE html>
<html>
<head>
  <title>Register Parking</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="config.js"></script>

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #FFD400;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }

    .phone {
      width: 360px;
      height: 700px;
      background: #FFD400;
      border-radius: 30px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.4);
      padding: 15px;
      overflow-y: auto;
    }

    input, textarea, button {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border-radius: 10px;
      border: none;
      font-size: 14px;
    }

    textarea {
      resize: none;
      height: 70px;
    }

    #map {
      width: 100%;
      height: 180px;
      border-radius: 12px;
      margin-top: 10px;
    }

    button {
      background: black;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }

    /* LOADING OVERLAY */
    .loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }

    .loading-box {
      background: white;
      padding: 40px;
      border-radius: 20px;
      text-align: center;
      box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
      animation: slideIn 0.3s ease-out;
      max-width: 300px;
    }

    @keyframes slideIn {
      from {
        transform: scale(0.8);
        opacity: 0;
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    .file-icon {
      font-size: 60px;
      margin-bottom: 15px;
      animation: bounce 1s infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #f0f0f0;
      border-radius: 10px;
      overflow: hidden;
      margin: 20px 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #FFD400, #FFC800);
      border-radius: 10px;
      animation: progress 2s ease-in-out;
    }

    @keyframes progress {
      from { width: 0%; }
      to { width: 100%; }
    }

    .loading-text {
      font-size: 18px;
      font-weight: bold;
      color: #333;
      margin-bottom: 8px;
    }

    .loading-subtext {
      font-size: 14px;
      color: #666;
    }

    .checkmark {
      display: none;
      font-size: 60px;
      color: #4CAF50;
      animation: scaleIn 0.3s ease-out;
    }

    @keyframes scaleIn {
      from {
        transform: scale(0);
      }
      to {
        transform: scale(1);
      }
    }
  </style>
</head>
<body>

<!-- LOADING OVERLAY -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-box">
    <div class="file-icon" id="fileIcon">üìÅ</div>
    <div class="checkmark" id="checkmark">‚úÖ</div>
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill"></div>
    </div>
    <div class="loading-text" id="loadingText">Saving Parking Space</div>
    <div class="loading-subtext" id="loadingSubtext">Uploading images and data to database...</div>
  </div>
</div>

<div class="phone">

  <h2>Register Parking Space</h2>

  <textarea id="notes" placeholder="Notes / Specification"></textarea>

  <!-- VEHICLE TYPES WITH PRICING -->
  <div style="background: #FFC800; padding: 15px; border-radius: 10px; margin: 10px 0;">
    <h4 style="margin: 0 0 10px 0;">Vehicle Types, Pricing & Slots:</h4>
    
    <label style="display: block; margin: 12px 0; font-size: 14px;">
      <input type="checkbox" id="vehicleCar" value="car" style="width: auto; margin-right: 8px;" onchange="togglePriceInput('Car')">
      üöó Car
    </label>
    <div id="carInputs" style="display: none; margin-left: 25px;">
      <input id="priceCar" type="number" placeholder="Price per hour (‚Çπ)" style="width: calc(50% - 5px); margin-right: 10px;">
      <input id="slotsCar" type="number" placeholder="Number of slots" min="1" value="1" style="width: calc(50% - 5px);">
    </div>
    
    <label style="display: block; margin: 12px 0; font-size: 14px;">
      <input type="checkbox" id="vehicleBike" value="bike" style="width: auto; margin-right: 8px;" onchange="togglePriceInput('Bike')">
      üèçÔ∏è Bike/Motorcycle
    </label>
    <div id="bikeInputs" style="display: none; margin-left: 25px;">
      <input id="priceBike" type="number" placeholder="Price per hour (‚Çπ)" style="width: calc(50% - 5px); margin-right: 10px;">
      <input id="slotsBike" type="number" placeholder="Number of slots" min="1" value="1" style="width: calc(50% - 5px);">
    </div>
    
    <label style="display: block; margin: 12px 0; font-size: 14px;">
      <input type="checkbox" id="vehicleBus" value="bus" style="width: auto; margin-right: 8px;" onchange="togglePriceInput('Bus')">
      üöå Bus
    </label>
    <div id="busInputs" style="display: none; margin-left: 25px;">
      <input id="priceBus" type="number" placeholder="Price per hour (‚Çπ)" style="width: calc(50% - 5px); margin-right: 10px;">
      <input id="slotsBus" type="number" placeholder="Number of slots" min="1" value="1" style="width: calc(50% - 5px);">
    </div>
    
    <label style="display: block; margin: 12px 0; font-size: 14px;">
      <input type="checkbox" id="vehicleHeavy" value="heavy" style="width: auto; margin-right: 8px;" onchange="togglePriceInput('Heavy')">
      üöõ Heavy Vehicle/Truck
    </label>
    <div id="heavyInputs" style="display: none; margin-left: 25px;">
      <input id="priceHeavy" type="number" placeholder="Price per hour (‚Çπ)" style="width: calc(50% - 5px); margin-right: 10px;">
      <input id="slotsHeavy" type="number" placeholder="Number of slots" min="1" value="1" style="width: calc(50% - 5px);">
    </div>
  </div>

  <!-- IMAGE UPLOAD -->
  <input id="images" type="file" accept="image/*" multiple>

  <!-- MAP -->
  <div id="map"></div>

  <button id="saveBtn" onclick="registerParking()">Save Parking Space</button>

</div>

<script>
let lat = null;
let lng = null;
let map, marker;

/* INIT MAP */
function initMap() {
  const defaultLoc = { lat: 9.9312, lng: 76.2673 };

  map = new google.maps.Map(document.getElementById("map"), {
    center: defaultLoc,
    zoom: 14,
  });

  map.addListener("click", (e) => {
    lat = e.latLng.lat();
    lng = e.latLng.lng();

    if (marker) marker.setMap(null);

    marker = new google.maps.Marker({
      position: { lat, lng },
      map: map,
    });
  });
}

/* TOGGLE PRICE INPUT */
function togglePriceInput(vehicleType) {
  const checkbox = document.getElementById(`vehicle${vehicleType}`);
  const inputsDiv = document.getElementById(`${vehicleType.toLowerCase()}Inputs`);
  
  if (checkbox.checked) {
    inputsDiv.style.display = 'block';
  } else {
    inputsDiv.style.display = 'none';
    document.getElementById(`price${vehicleType}`).value = '';
    document.getElementById(`slots${vehicleType}`).value = '1';
  }
}

/* REGISTER PARKING */
/* SHOW LOADING */
function showLoading() {
  document.getElementById('loadingOverlay').style.display = 'flex';
  document.getElementById('fileIcon').style.display = 'block';
  document.getElementById('checkmark').style.display = 'none';
  document.getElementById('loadingText').textContent = 'Saving Parking Space';
  document.getElementById('loadingSubtext').textContent = 'Uploading images and data to database...';
  
  // Restart progress animation
  const progressFill = document.getElementById('progressFill');
  progressFill.style.animation = 'none';
  setTimeout(() => {
    progressFill.style.animation = 'progress 2s ease-in-out';
  }, 10);
}

/* SHOW SUCCESS */
function showSuccess() {
  document.getElementById('fileIcon').style.display = 'none';
  document.getElementById('checkmark').style.display = 'block';
  document.getElementById('loadingText').textContent = 'Saved Successfully!';
  document.getElementById('loadingSubtext').textContent = 'Your parking space has been registered';
}

/* HIDE LOADING */
function hideLoading() {
  document.getElementById('loadingOverlay').style.display = 'none';
}

/* REGISTER PARKING */
function registerParking() {
  const notes = document.getElementById("notes").value;
  const files = document.getElementById("images").files;
  const ownerId = localStorage.getItem("ownerId");

  // Get selected vehicle types with prices and slots
  const vehicleTypes = [];
  const pricing = {};
  const slots = {};
  
  if (document.getElementById("vehicleCar").checked) {
    const price = document.getElementById("priceCar").value;
    const slotCount = document.getElementById("slotsCar").value;
    if (!price) {
      alert("Please enter price for Car");
      return;
    }
    if (!slotCount || slotCount < 1) {
      alert("Please enter number of slots for Car (minimum 1)");
      return;
    }
    vehicleTypes.push("car");
    pricing.car = parseFloat(price);
    slots.car = parseInt(slotCount);
  }
  
  if (document.getElementById("vehicleBike").checked) {
    const price = document.getElementById("priceBike").value;
    const slotCount = document.getElementById("slotsBike").value;
    if (!price) {
      alert("Please enter price for Bike");
      return;
    }
    if (!slotCount || slotCount < 1) {
      alert("Please enter number of slots for Bike (minimum 1)");
      return;
    }
    vehicleTypes.push("bike");
    pricing.bike = parseFloat(price);
    slots.bike = parseInt(slotCount);
  }
  
  if (document.getElementById("vehicleBus").checked) {
    const price = document.getElementById("priceBus").value;
    const slotCount = document.getElementById("slotsBus").value;
    if (!price) {
      alert("Please enter price for Bus");
      return;
    }
    if (!slotCount || slotCount < 1) {
      alert("Please enter number of slots for Bus (minimum 1)");
      return;
    }
    vehicleTypes.push("bus");
    pricing.bus = parseFloat(price);
    slots.bus = parseInt(slotCount);
  }
  
  if (document.getElementById("vehicleHeavy").checked) {
    const price = document.getElementById("priceHeavy").value;
    const slotCount = document.getElementById("slotsHeavy").value;
    if (!price) {
      alert("Please enter price for Heavy Vehicle");
      return;
    }
    if (!slotCount || slotCount < 1) {
      alert("Please enter number of slots for Heavy Vehicle (minimum 1)");
      return;
    }
    vehicleTypes.push("heavy");
    pricing.heavy = parseFloat(price);
    slots.heavy = parseInt(slotCount);
  }

  if (!notes || !lat || !lng) {
    alert("Fill all fields and select location");
    return;
  }

  if (vehicleTypes.length === 0) {
    alert("Please select at least one vehicle type");
    return;
  }

  if (files.length !== 3) {
    alert("Please upload exactly 3 images");
    return;
  }

  // Show loading animation
  showLoading();

  const formData = new FormData();
  formData.append("notes", notes);
  formData.append("ownerId", ownerId);
  formData.append("lat", lat);
  formData.append("lng", lng);
  formData.append("vehicleTypes", JSON.stringify(vehicleTypes));
  formData.append("pricing", JSON.stringify(pricing));
  formData.append("slots", JSON.stringify(slots));

  for (let i = 0; i < files.length; i++) {
    formData.append("images", files[i]);
  }

  fetch(getApiUrl("/api/parking/register"), {
    method: "POST",
    body: formData,
  })
    .then(res => res.json())
    .then(data => {
      if (!data.success) {
        hideLoading();
        alert("‚ùå Failed to register parking");
        return;
      }

      // Show success state
      showSuccess();
      
      // Wait 1.5 seconds to show success, then redirect
      setTimeout(() => {
        hideLoading();
        alert("‚úÖ Parking registered successfully!");
        window.location.href = "dashboard.html";
      }, 1500);
    })
    .catch((err) => {
      console.error('Registration error:', err);
      hideLoading();
      alert("‚ùå Server error. Please try again.");
    });
}
</script>

<!-- ‚ö†Ô∏è PUT YOUR GOOGLE MAPS API KEY -->
<script
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAzFgFejKDyyFfXqdOfaKmjPiAmXVHHZS4&callback=initMap"
  async defer>
</script>

</body>
</html>
