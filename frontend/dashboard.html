<!DOCTYPE html>
<html>
<head>
  <title>ASP Dashboard - A Space for Park</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="config.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      background: #FFD400;
      height: 100vh;
      overflow: hidden;
    }

    .dashboard-container {
      display: flex;
      height: 100vh;
    }

    /* LEFT SIDEBAR MENU */
    .left-sidebar {
      width: 80px;
      background: #FFC800;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px 0;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
    }

    .logo {
      font-size: 32px;
      margin-bottom: 30px;
    }

    .menu-item {
      width: 60px;
      height: 60px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin: 10px 0;
      cursor: pointer;
      border-radius: 12px;
      transition: all 0.3s;
    }

    .menu-item:hover {
      background: #FFB000;
    }

    .menu-item.active {
      background: #000;
      color: #FFD400;
    }

    .menu-icon {
      font-size: 24px;
    }

    .menu-label {
      font-size: 9px;
      margin-top: 3px;
    }

    .logout-menu {
      margin-top: auto;
      background: #ff4444;
      color: white;
    }

    /* MAIN CONTENT AREA */
    .main-content {
      flex: 1;
      padding: 30px;
      overflow-y: auto;
      background: #FFD400;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }

    .user-info {
      background: #FFC800;
      padding: 15px 20px;
      border-radius: 15px;
    }

    /* SECTIONS */
    .section {
      display: none;
    }

    .section.active {
      display: block;
    }

    /* STATS GRID */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 15px;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .stat-value {
      font-size: 32px;
      font-weight: bold;
      color: #333;
    }

    .stat-label {
      font-size: 13px;
      color: #666;
      margin-top: 8px;
    }

    /* CARD */
    .card {
      background: white;
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .card h4 {
      margin-bottom: 15px;
      color: #333;
    }

    .card button {
      padding: 10px 20px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      margin: 5px 5px 0 0;
      font-size: 14px;
      font-weight: bold;
    }

    .btn-edit {
      background: #4CAF50;
      color: white;
    }

    .btn-delete {
      background: #f44336;
      color: white;
    }

    .btn-primary {
      background: #000;
      color: white;
      width: 100%;
      padding: 14px;
      margin-top: 10px;
    }

    /* FORM */
    input, textarea {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: 1px solid #ddd;
      border-radius: 10px;
      font-size: 14px;
    }

    textarea {
      resize: vertical;
      min-height: 100px;
    }

    .image-preview {
      display: flex;
      gap: 10px;
      margin: 10px 0;
      flex-wrap: wrap;
    }

    .image-preview img {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 10px;
    }

    /* RIGHT SIDEBAR INBOX */
    .right-sidebar {
      width: 320px;
      background: #FFC800;
      padding: 20px;
      overflow-y: auto;
      box-shadow: -2px 0 10px rgba(0,0,0,0.1);
    }

    .inbox-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .inbox-header h3 {
      font-size: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .notification-icon {
      position: relative;
      font-size: 28px;
      cursor: pointer;
      animation: ring 2s infinite;
    }

    @keyframes ring {
      0%, 100% { transform: rotate(0deg); }
      10%, 30% { transform: rotate(-10deg); }
      20%, 40% { transform: rotate(10deg); }
    }

    .notification-badge {
      background: #ff4444;
      color: white;
      border-radius: 50%;
      min-width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: bold;
      padding: 0 5px;
      position: absolute;
      top: -5px;
      right: -5px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.15); }
    }

    .notification-badge.has-new {
      animation: pulse 1s infinite, glow 1.5s infinite;
    }

    @keyframes glow {
      0%, 100% { box-shadow: 0 0 5px #ff4444; }
      50% { box-shadow: 0 0 15px #ff4444, 0 0 25px #ff4444; }
    }

    .inbox-card {
      background: white;
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .inbox-card.pending {
      border-left: 4px solid #ff9800;
    }

    .inbox-card h4 {
      font-size: 14px;
      margin-bottom: 8px;
      color: #333;
    }

    .inbox-card p {
      font-size: 12px;
      color: #666;
      margin: 4px 0;
    }

    .inbox-card button {
      padding: 8px 15px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin: 8px 5px 0 0;
      font-size: 12px;
      font-weight: bold;
    }

    .btn-confirm {
      background: #4CAF50;
      color: white;
    }

    .btn-decline {
      background: #f44336;
      color: white;
    }

    /* RESPONSIVE */
    @media (max-width: 768px) {
      .right-sidebar {
        display: none;
      }
      
      .left-sidebar {
        width: 60px;
      }
      
      .menu-label {
        display: none;
      }
      
      .main-content {
        padding: 15px;
      }
      
      .stats-grid {
        grid-template-columns: 1fr 1fr;
      }
    }
  </style>
</head>
<body>

<div class="dashboard-container">
  <!-- LEFT SIDEBAR MENU -->
  <div class="left-sidebar">
    <div class="logo">üÖøÔ∏è</div>
    
    <div class="menu-item active" onclick="showSection('dashboardSection')" title="Dashboard">
      <span class="menu-icon">üè†</span>
      <div class="menu-label">Home</div>
    </div>
    
    <div class="menu-item" onclick="showSection('mySpacesSection')" title="My Spaces">
      <span class="menu-icon">üöó</span>
      <div class="menu-label">Spaces</div>
    </div>
    
    <div class="menu-item" onclick="showSection('bookingsSection')" title="Bookings">
      <span class="menu-icon">üìã</span>
      <div class="menu-label">Bookings</div>
    </div>
    
    <div class="menu-item" onclick="showSection('paymentsSection')" title="Payments">
      <span class="menu-icon">üí∞</span>
      <div class="menu-label">Payments</div>
    </div>
    
    <div class="menu-item" onclick="showSection('statsSection')" title="Statistics">
      <span class="menu-icon">üìä</span>
      <div class="menu-label">Stats</div>
    </div>
    
    <div class="menu-item" onclick="showSection('settingsSection')" title="Settings">
      <span class="menu-icon">‚öôÔ∏è</span>
      <div class="menu-label">Settings</div>
    </div>
    
    <div class="menu-item logout-menu" onclick="logout()" title="Logout">
      <span class="menu-icon">üö™</span>
      <div class="menu-label">Logout</div>
    </div>
  </div>

  <!-- MAIN CONTENT AREA -->
  <div class="main-content">
    <!-- DASHBOARD SECTION -->
    <div id="dashboardSection" class="section active">
      <div class="top-bar">
        <h2>Dashboard</h2>
        <div class="user-info">
          <b id="userName">Loading...</b><br>
          <small id="userEmail"></small>
        </div>
      </div>

      <!-- WALLET DISPLAY -->
      <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-bottom: 20px;">
        <h3 style="color: white; margin-bottom: 15px;">üí∞ Wallet Balance</h3>
        <div style="font-size: 36px; font-weight: bold; margin: 10px 0;">‚Çπ<span id="walletBalance">0</span></div>
        <div style="display: flex; justify-content: space-between; margin-top: 15px; font-size: 14px;">
          <div>
            <div style="opacity: 0.9;">Total Earnings</div>
            <div style="font-size: 18px; font-weight: bold;">‚Çπ<span id="totalEarnings">0</span></div>
          </div>
          <div style="text-align: right;">
            <div style="opacity: 0.9;">Last Transaction</div>
            <div style="font-size: 14px;" id="lastTransaction">-</div>
          </div>
        </div>
        <button class="btn-primary" style="margin-top: 15px; background: white; color: #667eea;" onclick="showSection('walletSection')">
          View Wallet Details
        </button>
      </div>

      <!-- VERIFICATION STATUS CARD -->
      <div id="verificationCard" class="card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; margin-bottom: 20px; display: none;">
        <h3 style="color: white; margin-bottom: 15px;">üõ°Ô∏è Insurance Protection</h3>
        <div id="verificationStatus"></div>
      </div>

      <div class="card">
        <h4>Quick Actions</h4>
        <button class="btn-primary" onclick="window.location.href='register-parking.html'">‚ûï Register New Space</button>
        <button class="btn-primary" onclick="window.location.href='vehicle-select.html'">üîç Find Parking</button>
        <button class="btn-primary" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border: none;" onclick="window.location.href='verification.html'">üõ°Ô∏è ASP Insurance Protection</button>
      </div>
    </div>

    <!-- MY SPACES SECTION -->
    <div id="mySpacesSection" class="section">
      <div class="top-bar">
        <h2>My Parking Spaces</h2>
      </div>
      <div id="spacesList"></div>
    </div>

    <!-- EDIT SPACE SECTION -->
    <div id="editSpaceSection" class="section">
      <div class="top-bar">
        <h2>Edit Parking Space</h2>
      </div>
      <div class="card">
        <input type="hidden" id="editSpaceId">
        
        <label><b>Description</b></label>
        <textarea id="editNotes" placeholder="Description and notes"></textarea>
        
        <label><b>Vehicle Types & Pricing (‚Çπ/hour)</b></label>
        <div style="background: #f5f5f5; padding: 15px; border-radius: 10px; margin: 10px 0;">
          <label style="display: block; margin: 12px 0;">
            <input type="checkbox" id="editVehicleCar" value="car" style="width: auto; margin-right: 8px;" onchange="toggleEditPriceInput('Car')">
            üöó Car
          </label>
          <input id="editPriceCar" type="number" placeholder="Price per hour for Car (‚Çπ)" style="display: none; margin-left: 25px; width: calc(100% - 25px);">
          
          <label style="display: block; margin: 12px 0;">
            <input type="checkbox" id="editVehicleBike" value="bike" style="width: auto; margin-right: 8px;" onchange="toggleEditPriceInput('Bike')">
            üèçÔ∏è Bike/Motorcycle
          </label>
          <input id="editPriceBike" type="number" placeholder="Price per hour for Bike (‚Çπ)" style="display: none; margin-left: 25px; width: calc(100% - 25px);">
          
          <label style="display: block; margin: 12px 0;">
            <input type="checkbox" id="editVehicleBus" value="bus" style="width: auto; margin-right: 8px;" onchange="toggleEditPriceInput('Bus')">
            üöå Bus
          </label>
          <input id="editPriceBus" type="number" placeholder="Price per hour for Bus (‚Çπ)" style="display: none; margin-left: 25px; width: calc(100% - 25px);">
          
          <label style="display: block; margin: 12px 0;">
            <input type="checkbox" id="editVehicleHeavy" value="heavy" style="width: auto; margin-right: 8px;" onchange="toggleEditPriceInput('Heavy')">
            üöõ Heavy Vehicle/Truck
          </label>
          <input id="editPriceHeavy" type="number" placeholder="Price per hour for Heavy Vehicle (‚Çπ)" style="display: none; margin-left: 25px; width: calc(100% - 25px);">
        </div>
        
        <label><b>Current Images</b></label>
        <div id="currentImages" class="image-preview"></div>
        
        <label><b>Upload New Images (optional, 3 images)</b></label>
        <input type="file" id="editImages" accept="image/*" multiple>
        
        <button class="btn-primary" onclick="updateSpace()">üíæ Save Changes</button>
        <button class="btn-primary" style="background: #666;" onclick="showSection('mySpacesSection')">‚ùå Cancel</button>
      </div>
    </div>

    <!-- STATS SECTION -->
    <div id="statsSection" class="section">
      <div class="top-bar">
        <h2>Statistics & Analytics</h2>
      </div>
      
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="stat_totalBookings">0</div>
          <div class="stat-label">Total Bookings</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat_completed">0</div>
          <div class="stat-label">Completed</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat_pending">0</div>
          <div class="stat-label">Pending</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat_active">0</div>
          <div class="stat-label">Active</div>
        </div>
      </div>

      <!-- Ratings & Reviews Section -->
      <div class="card" style="margin-top: 20px;">
        <h4>‚≠ê Your Ratings & Reviews</h4>
        <div id="ratingsOverview" style="margin: 15px 0;">
          <div style="display: flex; justify-content: space-around; margin-bottom: 20px;">
            <div style="text-align: center;">
              <div style="font-size: 3em; font-weight: bold; color: #FFD700;" id="averageRating">0</div>
              <div style="font-size: 2em; color: #FFD700;">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
              <div style="color: #666; font-size: 14px;" id="totalReviewsText">0 reviews</div>
            </div>
          </div>
        </div>
        <div id="reviewsList"></div>
      </div>

      <div class="card">
        <h4>Recent Activity</h4>
        <div id="recentActivity"></div>
      </div>
    </div>

    <!-- BOOKINGS SECTION (Mobile Friendly) -->
    <div id="bookingsSection" class="section">
      <div class="top-bar">
        <h2>üìã Booking Requests</h2>
      </div>
      <div id="bookingsList"></div>
    </div>

    <!-- PAYMENTS SECTION -->
    <div id="paymentsSection" class="section">
      <div class="top-bar">
        <h2>üí∞ Payment & Wallet</h2>
      </div>
      
      <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
        <h3 style="color: white;">Wallet Summary</h3>
        <div style="font-size: 32px; font-weight: bold; margin: 10px 0;">‚Çπ<span id="paymentWalletBalance">0</span></div>
        <div style="display: flex; justify-content: space-between; margin-top: 10px; font-size: 14px;">
          <div>
            <div style="opacity: 0.9;">Total Earnings</div>
            <div style="font-size: 18px; font-weight: bold;">‚Çπ<span id="paymentTotalEarnings">0</span></div>
          </div>
          <div style="text-align: right;">
            <div style="opacity: 0.9;">ASP Commission (18%)</div>
            <div style="font-size: 18px; font-weight: bold;">‚Çπ<span id="companyCommission">0</span></div>
          </div>
        </div>
        <button class="btn-primary" style="margin-top: 15px; background: white; color: #667eea;" onclick="showWithdrawalForm()">
          üí∏ Withdraw Funds
        </button>
      </div>

      <!-- Withdrawal Form -->
      <div id="withdrawalForm" class="card" style="display: none;">
        <h4>üí∏ Withdraw Funds</h4>
        <p style="font-size: 12px; color: #666; margin-bottom: 15px;">Minimum withdrawal: ‚Çπ100</p>
        
        <label>Account Holder Name</label>
        <input id="withdrawAccountName" type="text" placeholder="Enter account holder name" required>
        
        <label>Bank Account Number</label>
        <input id="withdrawAccountNumber" type="text" placeholder="Enter account number" required>
        
        <label>IFSC Code</label>
        <input id="withdrawIfsc" type="text" placeholder="Enter IFSC code" required>
        
        <label>Branch Name (Optional)</label>
        <input id="withdrawBranch" type="text" placeholder="Enter branch name">
        
        <label>UPI ID (Optional)</label>
        <input id="withdrawUpi" type="text" placeholder="Enter UPI ID (e.g., name@upi)">
        
        <label>Withdrawal Amount (‚Çπ)</label>
        <input id="withdrawAmount" type="number" placeholder="Enter amount" min="100" required>
        
        <div style="display: flex; gap: 10px; margin-top: 15px;">
          <button class="btn-primary" onclick="submitWithdrawal()">Submit Request</button>
          <button class="btn-primary" style="background: #999;" onclick="hideWithdrawalForm()">Cancel</button>
        </div>
      </div>

      <!-- Withdrawal History -->
      <div class="card">
        <h4>Withdrawal Requests</h4>
        <div id="withdrawalHistory"></div>
      </div>

      <div class="card">
        <h4>Transaction History</h4>
        <div id="paymentHistory"></div>
      </div>
    </div>

    <!-- SETTINGS SECTION -->
    <div id="settingsSection" class="section">
      <div class="top-bar">
        <h2>Settings</h2>
      </div>
      
      <div class="card">
        <h4>Account Information</h4>
        <p><b>Name:</b> <span id="settingsName"></span></p>
        <p><b>Email:</b> <span id="settingsEmail"></span></p>
        <p><b>User ID:</b> <span id="settingsId"></span></p>
      </div>

      <div class="card">
        <h4>Actions</h4>
        <button class="btn-primary" onclick="logout()">üö™ Logout</button>
      </div>
    </div>
  </div>

  <!-- RIGHT SIDEBAR INBOX -->
  <div class="right-sidebar">
    <div class="inbox-header">
      <h3>Inbox</h3>
      <div class="notification-icon">
        üîî
        <div class="notification-badge" id="notificationBadge">0</div>
      </div>
    </div>
    <div id="inboxList"></div>
  </div>
</div>

<script>
const ownerId = localStorage.getItem("ownerId");

// Load user info
document.getElementById("userName").innerText = localStorage.getItem("name") || "User";
document.getElementById("userEmail").innerText = localStorage.getItem("email") || "";
document.getElementById("settingsName").innerText = localStorage.getItem("name") || "User";
document.getElementById("settingsEmail").innerText = localStorage.getItem("email") || "";
document.getElementById("settingsId").innerText = ownerId || "N/A";

// Load wallet balance
function loadWallet() {
  fetch(getApiUrl(`/api/wallet/${ownerId}`))
    .then(res => res.json())
    .then(wallet => {
      document.getElementById('walletBalance').innerText = wallet.balance || 0;
      document.getElementById('totalEarnings').innerText = wallet.totalEarnings || 0;
      
      if (wallet.lastTransaction) {
        const date = new Date(wallet.lastTransaction);
        document.getElementById('lastTransaction').innerText = date.toLocaleDateString();
      }
    })
    .catch(err => console.error('Wallet error:', err));
}

// Load verification status
function loadVerificationStatus() {
  fetch(getApiUrl(`/api/verification/status/${ownerId}`))
    .then(res => res.json())
    .then(data => {
      const verificationCard = document.getElementById('verificationCard');
      const verificationStatus = document.getElementById('verificationStatus');
      
      if (data.verified) {
        const tierBadges = {
          silver: 'ü•à Silver',
          gold: 'ü•á Gold',
          platinum: 'üíé Platinum'
        };
        
        const tierColors = {
          silver: 'linear-gradient(135deg, #C0C0C0 0%, #E8E8E8 100%)',
          gold: 'linear-gradient(135deg, #FFD700 0%, #FFA500 100%)',
          platinum: 'linear-gradient(135deg, #E5E4E2 0%, #BCC6CC 100%)'
        };
        
        const expiryDate = new Date(data.expiresAt).toLocaleDateString();
        const daysLeft = Math.ceil((new Date(data.expiresAt) - new Date()) / (1000 * 60 * 60 * 24));
        
        verificationCard.style.background = tierColors[data.tier];
        verificationCard.style.color = data.tier === 'silver' || data.tier === 'platinum' ? '#000' : '#fff';
        
        verificationStatus.innerHTML = `
          <div style="font-size: 28px; font-weight: bold; margin-bottom: 10px;">
            ${tierBadges[data.tier]} Verified
          </div>
          <div style="font-size: 14px; opacity: 0.9; margin-bottom: 15px;">
            <p><strong>Expires:</strong> ${expiryDate} (${daysLeft} days left)</p>
            <p><strong>Claim Limit:</strong> ‚Çπ${data.claimLimit.toLocaleString()}</p>
            <p><strong>Price Boost:</strong> +${data.priceBoost}% on all bookings</p>
          </div>
          <button class="btn-primary" style="background: rgba(255,255,255,0.3); color: inherit; border: 2px solid currentColor;" onclick="window.location.href='verification.html'">
            Upgrade Plan
          </button>
        `;
        
        verificationCard.style.display = 'block';
      } else {
        verificationCard.style.background = 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)';
        verificationCard.style.color = 'white';
        
        verificationStatus.innerHTML = `
          <div style="font-size: 18px; margin-bottom: 15px;">
            <p>üîí Get verified and earn more!</p>
            <p style="font-size: 14px; opacity: 0.9; margin-top: 10px;">
              Increase trust, get insurance protection, and boost your parking prices by up to 15%
            </p>
          </div>
          <button class="btn-primary" style="background: white; color: #f5576c;" onclick="window.location.href='verification.html'">
            Get Verified Now
          </button>
        `;
        
        verificationCard.style.display = 'block';
      }
    })
    .catch(err => console.error('Verification status error:', err));
}

// Show section and update menu

function showSection(sectionId) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
  
  document.getElementById(sectionId).classList.add('active');
  
  const menuItems = document.querySelectorAll('.menu-item');
  if (sectionId === 'dashboardSection') {
    menuItems[0].classList.add('active');
    loadDashboardStats();
  } else if (sectionId === 'mySpacesSection') {
    menuItems[1].classList.add('active');
    loadMySpaces();
  } else if (sectionId === 'bookingsSection') {
    menuItems[2].classList.add('active');
    loadBookingsSection();
  } else if (sectionId === 'paymentsSection') {
    menuItems[3].classList.add('active');
    loadPaymentsSection();
  } else if (sectionId === 'statsSection') {
    menuItems[4].classList.add('active');
    loadDetailedStats();
  } else if (sectionId === 'settingsSection') {
    menuItems[5].classList.add('active');
  }
}

// Load dashboard statistics
function loadDashboardStats() {
  fetch(getApiUrl(`/api/booking/owner/${ownerId}`))
    .then(res => res.json())
    .then(data => {
      const total = data.length;
      const active = data.filter(b => b.status === 'active').length;
      
      let totalHours = 0;
      let totalEarnings = 0;
      
      data.forEach(booking => {
        if (booking.startTime && booking.endTime) {
          const hours = (new Date(booking.endTime) - new Date(booking.startTime)) / (1000 * 60 * 60);
          totalHours += hours;
          totalEarnings += hours * (booking.price || 0);
        }
      });
      
      document.getElementById('totalBookings').innerText = total;
      document.getElementById('activeBookings').innerText = active;
      document.getElementById('totalHours').innerText = Math.round(totalHours);
      document.getElementById('totalEarnings').innerText = Math.round(totalEarnings);
    })
    .catch(err => console.error('Stats error:', err));
}

// Load detailed statistics
function loadDetailedStats() {
  fetch(getApiUrl(`/api/booking/owner/${ownerId}`))
    .then(res => res.json())
    .then(data => {
      const total = data.length;
      const completed = data.filter(b => b.status === 'completed').length;
      const pending = data.filter(b => b.status === 'pending').length;
      const active = data.filter(b => b.status === 'active').length;
      
      document.getElementById('stat_totalBookings').innerText = total;
      document.getElementById('stat_completed').innerText = completed;
      document.getElementById('stat_pending').innerText = pending;
      document.getElementById('stat_active').innerText = active;
      
      // Recent activity
      const activityDiv = document.getElementById('recentActivity');
      if (data.length === 0) {
        activityDiv.innerHTML = '<p>No recent activity</p>';
        return;
      }
      
      activityDiv.innerHTML = data.slice(0, 5).map(b => `
        <p><b>${b.driverName || 'Unknown'}</b> - ${b.status} - ${new Date(b.createdAt).toLocaleDateString()}</p>
      `).join('');
    })
    .catch(err => console.error('Detailed stats error:', err));
  
  // Load ratings and reviews
  loadRatingsStats();
}

// Load ratings statistics
function loadRatingsStats() {
  // Get all parking spaces for this owner
  fetch(getApiUrl(`/api/parking/owner/${ownerId}`))
    .then(res => res.json())
    .then(spaces => {
      if (spaces.length === 0) {
        document.getElementById('ratingsOverview').innerHTML = '<p>No parking spaces to show ratings</p>';
        return;
      }
      
      // Calculate overall statistics
      let totalRating = 0;
      let totalReviews = 0;
      let allReviews = [];
      
      // Fetch reviews for each parking space
      const reviewPromises = spaces.map(space => 
        fetch(getApiUrl(`/api/reviews/parking/${space._id}`))
          .then(r => r.json())
          .then(reviews => {
            if (space.averageRating) {
              totalRating += space.averageRating * (space.totalReviews || 0);
              totalReviews += space.totalReviews || 0;
            }
            return reviews.map(r => ({...r, spaceName: space.notes || 'Parking Space'}));
          })
      );
      
      Promise.all(reviewPromises)
        .then(reviewArrays => {
          allReviews = reviewArrays.flat();
          
          const overallAverage = totalReviews > 0 ? (totalRating / totalReviews).toFixed(1) : 0;
          const stars = overallAverage > 0 ? '‚≠ê'.repeat(Math.round(overallAverage)) : '‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ';
          
          document.getElementById('averageRating').innerText = overallAverage;
          document.getElementById('totalReviewsText').innerText = `${totalReviews} review${totalReviews !== 1 ? 's' : ''}`;
          
          // Display recent reviews
          const reviewsList = document.getElementById('reviewsList');
          if (allReviews.length === 0) {
            reviewsList.innerHTML = '<p style="text-align:center;color:#666;">No reviews yet</p>';
            return;
          }
          
          // Sort by date and show latest 10
          allReviews.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
          
          reviewsList.innerHTML = allReviews.slice(0, 10).map(review => `
            <div style="border-bottom: 1px solid #eee; padding: 12px 0;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                <div>
                  <b style="color: #333;">${review.userName}</b>
                  <div style="font-size: 11px; color: #999;">${review.spaceName}</div>
                </div>
                <div style="color: #FFD700; font-size: 16px;">${'‚≠ê'.repeat(review.rating)}</div>
              </div>
              ${review.comment ? `<p style="font-size: 13px; color: #666; margin: 5px 0;">${review.comment}</p>` : ''}
              <div style="font-size: 11px; color: #999;">${new Date(review.createdAt).toLocaleDateString()}</div>
            </div>
          `).join('');
        })
        .catch(err => console.error('Error loading reviews:', err));
    })
    .catch(err => console.error('Error loading parking spaces:', err));
}

// Load my parking spaces
function loadMySpaces() {
  fetch(getApiUrl(`/api/parking/owner/${ownerId}`))
    .then(res => res.json())
    .then(data => {
      console.log("Loaded spaces:", data);
      console.log("Number of spaces:", data.length);
      
      const list = document.getElementById('spacesList');
      
      if (data.length === 0) {
        list.innerHTML = '<div class="card">No parking spaces registered yet.</div>';
        return;
      }
      
      // Remove duplicates based on _id
      const uniqueSpaces = data.filter((space, index, self) =>
        index === self.findIndex((s) => s._id === space._id)
      );
      
      console.log("Unique spaces:", uniqueSpaces.length);
      
      const vehicleIcons = {
        car: 'üöó',
        bike: 'üèçÔ∏è',
        bus: 'üöå',
        heavy: 'üöõ'
      };
      
      list.innerHTML = uniqueSpaces.map(space => {
        // Display pricing per vehicle type
        let pricingDisplay = '';
        if (space.pricing && Object.keys(space.pricing).length > 0) {
          pricingDisplay = '<div style="margin: 10px 0; font-size: 14px;">';
          for (const [vType, vPrice] of Object.entries(space.pricing)) {
            pricingDisplay += `<div>${vehicleIcons[vType] || vType} <b>‚Çπ${vPrice}/hour</b></div>`;
          }
          pricingDisplay += '</div>';
        } else if (space.price) {
          pricingDisplay = `<h4>‚Çπ${space.price}/hour</h4>`;
        } else {
          pricingDisplay = '<h4>No pricing set</h4>';
        }
        
        return `
          <div class="card">
            ${pricingDisplay}
            <p>${space.notes || 'No description'}</p>
            <div class="image-preview">
              ${space.images && space.images.length > 0 ? space.images.map(img => `<img src="${getApiUrl(img)}" alt="Space">`).join('') : '<p>No images</p>'}
            </div>
            <button class="btn-edit" onclick="editSpace('${space._id}')">‚úèÔ∏è Edit</button>
            <button class="btn-delete" onclick="deleteSpace('${space._id}')">üóëÔ∏è Delete</button>
          </div>
        `;
      }).join('');
    })
    .catch(err => console.error('Load spaces error:', err));
}

// Toggle price input for edit
function toggleEditPriceInput(vehicleType) {
  const checkbox = document.getElementById(`editVehicle${vehicleType}`);
  const priceInput = document.getElementById(`editPrice${vehicleType}`);
  
  if (checkbox.checked) {
    priceInput.style.display = 'block';
  } else {
    priceInput.style.display = 'none';
    priceInput.value = '';
  }
}

// Edit space
function editSpace(spaceId) {
  fetch(getApiUrl(`/api/parking/${spaceId}`))
    .then(res => res.json())
    .then(space => {
      document.getElementById('editSpaceId').value = space._id;
      document.getElementById('editNotes').value = space.notes;
      
      // Load pricing per vehicle type
      if (space.pricing && Object.keys(space.pricing).length > 0) {
        // New pricing format
        for (const [vType, vPrice] of Object.entries(space.pricing)) {
          const vTypeCapitalized = vType.charAt(0).toUpperCase() + vType.slice(1);
          const checkbox = document.getElementById(`editVehicle${vTypeCapitalized}`);
          const priceInput = document.getElementById(`editPrice${vTypeCapitalized}`);
          
          if (checkbox && priceInput) {
            checkbox.checked = true;
            priceInput.style.display = 'block';
            priceInput.value = vPrice;
          }
        }
      } else if (space.price) {
        // Old pricing format - default to car
        document.getElementById('editVehicleCar').checked = true;
        document.getElementById('editPriceCar').style.display = 'block';
        document.getElementById('editPriceCar').value = space.price;
      }
      
      // Load vehicle types
      if (space.vehicleTypes && space.vehicleTypes.length > 0) {
        space.vehicleTypes.forEach(vType => {
          const vTypeCapitalized = vType.charAt(0).toUpperCase() + vType.slice(1);
          const checkbox = document.getElementById(`editVehicle${vTypeCapitalized}`);
          if (checkbox && !checkbox.checked) {
            checkbox.checked = true;
            toggleEditPriceInput(vTypeCapitalized);
          }
        });
      }
      
      const imagesDiv = document.getElementById('currentImages');
      imagesDiv.innerHTML = space.images.map(img => 
        `<img src="${getApiUrl(img)}" alt="Space">`
      ).join('');
      
      showSection('editSpaceSection');
    });
}

// Update space
function updateSpace() {
  const spaceId = document.getElementById('editSpaceId').value;
  const notes = document.getElementById('editNotes').value;
  const files = document.getElementById('editImages').files;
  
  // Get selected vehicle types with prices
  const vehicleTypes = [];
  const pricing = {};
  
  if (document.getElementById('editVehicleCar').checked) {
    const price = document.getElementById('editPriceCar').value;
    if (!price) {
      alert("Please enter price for Car");
      return;
    }
    vehicleTypes.push("car");
    pricing.car = parseFloat(price);
  }
  
  if (document.getElementById('editVehicleBike').checked) {
    const price = document.getElementById('editPriceBike').value;
    if (!price) {
      alert("Please enter price for Bike");
      return;
    }
    vehicleTypes.push("bike");
    pricing.bike = parseFloat(price);
  }
  
  if (document.getElementById('editVehicleBus').checked) {
    const price = document.getElementById('editPriceBus').value;
    if (!price) {
      alert("Please enter price for Bus");
      return;
    }
    vehicleTypes.push("bus");
    pricing.bus = parseFloat(price);
  }
  
  if (document.getElementById('editVehicleHeavy').checked) {
    const price = document.getElementById('editPriceHeavy').value;
    if (!price) {
      alert("Please enter price for Heavy Vehicle");
      return;
    }
    vehicleTypes.push("heavy");
    pricing.heavy = parseFloat(price);
  }
  
  if (vehicleTypes.length === 0) {
    alert("Please select at least one vehicle type");
    return;
  }
  
  // If images are provided, validate count
  if (files.length > 0 && files.length !== 3) {
    alert("Please upload exactly 3 images or leave empty to keep current images");
    return;
  }
  
  const formData = new FormData();
  formData.append('notes', notes);
  formData.append('vehicleTypes', JSON.stringify(vehicleTypes));
  formData.append('pricing', JSON.stringify(pricing));
  
  // Add new images if provided
  if (files.length === 3) {
    for (let i = 0; i < files.length; i++) {
      formData.append('images', files[i]);
    }
  }
  
  fetch(getApiUrl(`/api/parking/${spaceId}`), {
    method: 'PUT',
    body: formData
  })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        alert('Space updated successfully!');
        loadMySpaces();
        showSection('mySpacesSection');
      } else {
        alert('Update failed: ' + (data.error || 'Unknown error'));
      }
    })
    .catch(err => {
      console.error('Update error:', err);
      alert('Error updating space');
    });
}

// Delete space
function deleteSpace(spaceId) {
  if (!confirm('Are you sure you want to delete this parking space?')) return;
  
  fetch(getApiUrl(`/api/parking/${spaceId}`), { method: 'DELETE' })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        alert('Space deleted successfully!');
        loadMySpaces();
      } else {
        alert('Delete failed');
      }
    })
    .catch(err => {
      console.error('Delete error:', err);
      alert('Error deleting space');
    });
}

// Load inbox bookings
let previousPendingCount = 0;

function loadInbox() {
  fetch(getApiUrl(`/api/booking/owner/${ownerId}`))
    .then(res => res.json())
    .then(data => {
      const list = document.getElementById('inboxList');
      const pendingCount = data.filter(b => b.status === 'pending').length;
      
      // Update notification badge
      const badge = document.getElementById('notificationBadge');
      badge.innerText = pendingCount;
      
      // Add special styling if there are new bookings
      if (pendingCount > previousPendingCount && previousPendingCount > 0) {
        badge.classList.add('has-new');
        // Play notification sound (optional)
        playNotificationSound();
        // Show browser notification
        showBrowserNotification(pendingCount);
      } else if (pendingCount === 0) {
        badge.classList.remove('has-new');
      }
      
      previousPendingCount = pendingCount;
      
      if (data.length === 0) {
        list.innerHTML = '<div class="inbox-card"><p>No bookings yet</p></div>';
        return;
      }
      
      // Sort by date, newest first
      data.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      
      const vehicleIcons = {
        car: 'üöó',
        bike: 'üèçÔ∏è',
        bus: 'üöå',
        heavy: 'üöõ'
      };
      
      list.innerHTML = data.map(booking => `
        <div class="inbox-card ${booking.status === 'pending' ? 'pending' : ''}">
          <h4>${vehicleIcons[booking.vehicleType] || 'üöó'} ${booking.driverName || 'Unknown Driver'}</h4>
          <p><b>Vehicle:</b> ${booking.vehicleType ? booking.vehicleType.toUpperCase() : 'CAR'}</p>
          <p><b>Status:</b> ${booking.status}</p>
          <p><b>Price:</b> ‚Çπ${booking.price}/hour</p>
          <p><b>Date:</b> ${new Date(booking.createdAt).toLocaleString()}</p>
          ${booking.status === 'pending' ? `
            <button class="btn-confirm" onclick="confirmBooking('${booking._id}')">‚úÖ Confirm</button>
            <button class="btn-decline" onclick="declineBooking('${booking._id}')">‚ùå Decline</button>
          ` : ''}
          ${booking.status === 'confirmed' && booking.otp ? `
            <div style="background: #4CAF50; color: white; padding: 10px; border-radius: 8px; margin-top: 8px;">
              <b>OTP:</b> <span style="font-size: 20px; letter-spacing: 3px;">${booking.otp}</span>
            </div>
            <p style="font-size: 11px; color: #666; margin-top: 5px;">Share this OTP with driver</p>
          ` : ''}
        </div>
      `).join('');
    })
    .catch(err => console.error('Load inbox error:', err));
}

// Play notification sound
function playNotificationSound() {
  // Create a simple beep sound
  const audioContext = new (window.AudioContext || window.webkitAudioContext)();
  const oscillator = audioContext.createOscillator();
  const gainNode = audioContext.createGain();
  
  oscillator.connect(gainNode);
  gainNode.connect(audioContext.destination);
  
  oscillator.frequency.value = 800;
  oscillator.type = 'sine';
  
  gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
  gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
  
  oscillator.start(audioContext.currentTime);
  oscillator.stop(audioContext.currentTime + 0.5);
}

// Show browser notification
function showBrowserNotification(count) {
  if ('Notification' in window && Notification.permission === 'granted') {
    new Notification('New Booking Request!', {
      body: `You have ${count} pending booking request${count > 1 ? 's' : ''}`,
      icon: 'üÖøÔ∏è',
      badge: 'üîî'
    });
  }
}

// Request notification permission on load
if ('Notification' in window && Notification.permission === 'default') {
  Notification.requestPermission();
}

// Confirm booking
function confirmBooking(id) {
  fetch(getApiUrl(`/api/booking/confirm/${id}`), { method: 'POST' })
    .then(res => res.json())
    .then(data => {
      alert('Booking confirmed! OTP: ' + data.otp);
      loadInbox();
      loadDashboardStats();
    });
}

// Decline booking
function declineBooking(id) {
  fetch(getApiUrl(`/api/booking/decline/${id}`), { method: 'POST' })
    .then(() => {
      alert('Booking declined');
      loadInbox();
      loadDashboardStats();
    });
}

// Load bookings section (mobile friendly)
function loadBookingsSection() {
  fetch(getApiUrl(`/api/booking/owner/${ownerId}`))
    .then(res => res.json())
    .then(data => {
      const list = document.getElementById('bookingsList');
      
      if (data.length === 0) {
        list.innerHTML = '<div class="card">No bookings yet</div>';
        return;
      }
      
      data.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      
      const vehicleIcons = {
        car: 'üöó',
        bike: 'üèçÔ∏è',
        bus: 'üöå',
        heavy: 'üöõ'
      };
      
      list.innerHTML = data.map(booking => `
        <div class="card">
          <h4>${vehicleIcons[booking.vehicleType] || 'üöó'} ${booking.driverName || 'Unknown Driver'}</h4>
          <p><b>Vehicle:</b> ${booking.vehicleType ? booking.vehicleType.toUpperCase() : 'CAR'}</p>
          <p><b>Status:</b> ${booking.status}</p>
          <p><b>Price:</b> ‚Çπ${booking.price}/hour</p>
          <p><b>Date:</b> ${new Date(booking.createdAt).toLocaleString()}</p>
          ${booking.status === 'pending' ? `
            <button class="btn-edit" onclick="confirmBooking('${booking._id}')">‚úÖ Confirm</button>
            <button class="btn-delete" onclick="declineBooking('${booking._id}')">‚ùå Decline</button>
          ` : ''}
          ${booking.status === 'confirmed' && booking.otp ? `
            <div style="background: #4CAF50; color: white; padding: 10px; border-radius: 8px; margin-top: 8px;">
              <b>OTP:</b> <span style="font-size: 20px; letter-spacing: 3px;">${booking.otp}</span>
            </div>
            <p style="font-size: 11px; color: #666; margin-top: 5px;">Share this OTP with driver</p>
          ` : ''}
        </div>
      `).join('');
    })
    .catch(err => console.error('Load bookings error:', err));
}

// Load payments section
function loadPaymentsSection() {
  // Load wallet
  fetch(getApiUrl(`/api/wallet/${ownerId}`))
    .then(res => res.json())
    .then(wallet => {
      document.getElementById('paymentWalletBalance').innerText = wallet.balance || 0;
      document.getElementById('paymentTotalEarnings').innerText = wallet.totalEarnings || 0;
      
      // Calculate company commission (18% of total earnings)
      const commission = Math.round((wallet.totalEarnings || 0) * 0.18);
      document.getElementById('companyCommission').innerText = commission;
    })
    .catch(err => console.error('Load wallet error:', err));
  
  // Load transaction history
  fetch(getApiUrl(`/api/wallet/${ownerId}/transactions`))
    .then(res => res.json())
    .then(transactions => {
      const list = document.getElementById('paymentHistory');
      
      if (transactions.length === 0) {
        list.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No transactions yet</p>';
        return;
      }
      
      list.innerHTML = transactions.map(tx => `
        <div style="border-bottom: 1px solid #eee; padding: 10px 0;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <b>${tx.type === 'credit' ? 'üí∞ Received' : 'üí∏ Withdrawal'}</b>
              <p style="font-size: 12px; color: #666; margin: 5px 0;">${tx.description}</p>
              ${tx.driverName ? `<p style="font-size: 11px; color: #999;">üë§ Driver: ${tx.driverName}</p>` : ''}
              ${tx.parkingDuration ? `<p style="font-size: 11px; color: #999;">‚è±Ô∏è Duration: ${tx.parkingDuration} minutes</p>` : ''}
              <small style="color: #999;">${new Date(tx.createdAt).toLocaleString()}</small>
            </div>
            <div style="text-align: right;">
              <div style="font-size: 18px; font-weight: bold; color: ${tx.type === 'credit' ? '#4CAF50' : '#f44336'};">
                ${tx.type === 'credit' ? '+' : '-'}‚Çπ${tx.amount}
              </div>
              <small style="color: #999;">Balance: ‚Çπ${tx.balanceAfter}</small>
            </div>
          </div>
          ${tx.type === 'credit' && tx.totalPayment ? `
            <div style="background: #f5f5f5; padding: 8px; border-radius: 5px; margin-top: 8px; font-size: 12px;">
              <b>üí≥ Payment Breakdown:</b><br>
              <div style="display: flex; justify-content: space-between; margin: 3px 0;">
                <span>Total Payment:</span>
                <span><b>‚Çπ${tx.totalPayment}</b></span>
              </div>
              <div style="display: flex; justify-content: space-between; margin: 3px 0; color: #4CAF50;">
                <span>Your Share (82%):</span>
                <span><b>‚Çπ${tx.providerShare}</b></span>
              </div>
              <div style="display: flex; justify-content: space-between; margin: 3px 0; color: #ff9800;">
                <span>Company Commission (18%):</span>
                <span><b>‚Çπ${tx.commission}</b></span>
              </div>
            </div>
          ` : ''}
        </div>
      `).join('');
    })
    .catch(err => console.error('Load transactions error:', err));
  
  // Load withdrawal history
  loadWithdrawalHistory();
}

// Show withdrawal form
function showWithdrawalForm() {
  document.getElementById('withdrawalForm').style.display = 'block';
  // Scroll to form
  document.getElementById('withdrawalForm').scrollIntoView({ behavior: 'smooth' });
}

// Hide withdrawal form
function hideWithdrawalForm() {
  document.getElementById('withdrawalForm').style.display = 'none';
  // Clear form
  document.getElementById('withdrawAccountName').value = '';
  document.getElementById('withdrawAccountNumber').value = '';
  document.getElementById('withdrawIfsc').value = '';
  document.getElementById('withdrawBranch').value = '';
  document.getElementById('withdrawUpi').value = '';
  document.getElementById('withdrawAmount').value = '';
}

// Submit withdrawal request
async function submitWithdrawal() {
  const accountName = document.getElementById('withdrawAccountName').value.trim();
  const accountNumber = document.getElementById('withdrawAccountNumber').value.trim();
  const ifscCode = document.getElementById('withdrawIfsc').value.trim().toUpperCase();
  const branch = document.getElementById('withdrawBranch').value.trim();
  const upiId = document.getElementById('withdrawUpi').value.trim();
  const amount = parseFloat(document.getElementById('withdrawAmount').value);
  
  // Validation
  if (!accountName || !accountNumber || !ifscCode || !amount) {
    alert('Please fill in all required fields');
    return;
  }
  
  if (amount < 100) {
    alert('Minimum withdrawal amount is ‚Çπ100');
    return;
  }
  
  // Get current balance
  const walletResponse = await fetch(getApiUrl(`/api/wallet/${ownerId}`));
  const wallet = await walletResponse.json();
  
  if (amount > wallet.balance) {
    alert(`Insufficient balance. Available: ‚Çπ${wallet.balance}`);
    return;
  }
  
  // Confirm withdrawal
  if (!confirm(`Withdraw ‚Çπ${amount} to account ${accountNumber}?\n\nThis request will be processed by ASP admin.`)) {
    return;
  }
  
  try {
    const response = await fetch(getApiUrl('/api/wallet/withdraw'), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        ownerId,
        amount,
        accountHolderName: accountName,
        accountNumber,
        ifscCode,
        upiId: upiId || undefined
      })
    });
    
    const data = await response.json();
    
    if (data.success) {
      alert('‚úÖ Withdrawal request submitted successfully!\n\nYour request is pending approval. You will receive the funds once approved by ASP admin.');
      hideWithdrawalForm();
      loadWithdrawalHistory();
    } else {
      alert('‚ùå Error: ' + (data.error || 'Failed to submit withdrawal request'));
    }
  } catch (err) {
    console.error('Withdrawal error:', err);
    alert('‚ùå Failed to submit withdrawal request. Please try again.');
  }
}

// Load withdrawal history
function loadWithdrawalHistory() {
  fetch(getApiUrl(`/api/wallet/${ownerId}/withdrawals`))
    .then(res => res.json())
    .then(withdrawals => {
      const list = document.getElementById('withdrawalHistory');
      
      if (withdrawals.length === 0) {
        list.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No withdrawal requests yet</p>';
        return;
      }
      
      list.innerHTML = withdrawals.map(w => {
        // Status colors and icons
        const statusConfig = {
          pending: { color: '#ff9800', icon: '‚è≥', text: 'Pending' },
          approved: { color: '#2196F3', icon: '‚úì', text: 'Approved' },
          completed: { color: '#4CAF50', icon: '‚úì', text: 'Completed' },
          rejected: { color: '#f44336', icon: '‚úó', text: 'Rejected' }
        };
        
        const status = statusConfig[w.status] || statusConfig.pending;
        
        return `
          <div style="border: 2px solid ${status.color}; border-radius: 8px; padding: 12px; margin-bottom: 10px; background: ${status.color}10;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <div style="font-size: 20px; font-weight: bold; color: ${status.color};">
                ‚Çπ${w.amount}
              </div>
              <div style="background: ${status.color}; color: white; padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: bold;">
                ${status.icon} ${status.text}
              </div>
            </div>
            
            <div style="font-size: 13px; color: #666;">
              <p style="margin: 4px 0;"><b>Account:</b> ${w.accountNumber}</p>
              <p style="margin: 4px 0;"><b>IFSC:</b> ${w.ifscCode}</p>
              <p style="margin: 4px 0;"><b>Account Holder:</b> ${w.accountHolderName}</p>
              ${w.upiId ? `<p style="margin: 4px 0;"><b>UPI:</b> ${w.upiId}</p>` : ''}
              <p style="margin: 4px 0;"><b>Requested:</b> ${new Date(w.requestDate || w.createdAt).toLocaleString()}</p>
              ${w.processedDate ? `<p style="margin: 4px 0;"><b>Processed:</b> ${new Date(w.processedDate).toLocaleString()}</p>` : ''}
              ${w.adminNotes ? `<p style="margin: 4px 0; color: ${status.color};"><b>Note:</b> ${w.adminNotes}</p>` : ''}
            </div>
          </div>
        `;
      }).join('');
    })
    .catch(err => console.error('Load withdrawals error:', err));
}

// Logout
function logout() {
  if (confirm('Are you sure you want to logout?')) {
    localStorage.clear();
    window.location.href = 'login.html';
  }
}

// Load initial data
loadDashboardStats();
loadWallet();
loadVerificationStatus();
loadInbox();

// Auto-refresh inbox and wallet every 30 seconds
setInterval(() => {
  loadInbox();
  loadWallet();
  loadVerificationStatus();
}, 30000);
</script>

</body>
</html>
